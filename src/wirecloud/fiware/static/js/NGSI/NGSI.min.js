!function(){"use strict";var e;const t=new WeakMap;if("function"==typeof require&&"undefined"!==typeof exports){e=exports;var r=require("whatwg-url").URL}else{e={};r=window.URL;var n=function(e){return Array.prototype.slice.call(arguments,1).forEach((function(t){null!=t&&Object.keys(t).forEach((function(r){e[r]=t[r]}))})),e},o=function(){var e,t;for(t in e=n({Accept:"application/json, */*"},this.options.requestHeaders),null==this.options.postBody||"Content-Type"in e||null==this.options.contentType||(e["Content-Type"]=this.options.contentType,null!=this.options.encoding&&(e["Content-Type"]+="; charset="+this.options.encoding)),e)null!=e[t]&&this.transport.setRequestHeader(t,e[t])},i=function(e){Object.defineProperties(this,{request:{value:e},transport:{value:e.transport},status:{value:e.transport.status},statusText:{value:e.transport.statusText},response:{value:e.transport.response}}),null!=e.options.responseType&&""!==e.options.responseType||Object.defineProperties(this,{responseText:{value:e.transport.responseText},responseXML:{value:e.transport.responseXML}})};i.prototype.getHeader=function(e){try{return this.transport.getResponseHeader(e)}catch(e){return null}};var s=function(t,r){this.options=n({method:"POST",asynchronous:!0,responseType:null,contentType:null,encoding:null,postBody:null},r),Object.defineProperties(this,{method:{value:this.options.method.toUpperCase()}});var s=function(e){var t,r=[];if(null==e||"object"!=typeof e)return null;for(t in e)void 0!==e[t]&&(null===e[t]?r.push(encodeURIComponent(t)+"="):r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t])));return r.length>0?r.join("&"):null}(this.options.parameters);-1!==["PUT","POST"].indexOf(this.method)&&null==this.options.postBody?null!=s&&(this.options.postBody=s,null==this.options.contentType&&(this.options.contentType="application/x-www-form-urlencoded"),null==this.options.encoding&&(this.options.encoding="UTF-8")):null!=s&&(""!==t.search?t.search=t.search+"&"+s:t.search="?"+s),Object.defineProperties(this,{url:{value:t},abort:{value:function(){return this.transport.aborted=!0,this.transport.abort(),this}}}),Object.defineProperty(this,"transport",{value:new XMLHttpRequest}),!0===this.options.withCredentials&&this.options.supportsAccessControl&&(this.transport.withCredentials=!0),this.options.responseType&&(this.transport.responseType=this.options.responseType),this.promise=new Promise(function(t,r){this.transport.addEventListener("abort",(function(e){e.stopPropagation(),e.preventDefault(),r("aborted")})),this.transport.addEventListener("load",function(){var e=new i(this);t(e)}.bind(this)),this.transport.addEventListener("error",function(){r(new e.ConnectionError(this))}.bind(this))}.bind(this)),this.transport.open(this.method,this.url,this.options.asynchronous),o.call(this),this.transport.send(this.options.postBody)};s.prototype.then=function(e,t){return this.promise.then(e,t)},s.prototype.catch=function(e){return this.promise.catch(e)};var a=function(e,t){return new s(e,t)}}e.endpoints={SERVER_DETAILS:"version",v1:{REGISTER_CONTEXT:"v1/registry/registerContext",DISCOVER_CONTEXT_AVAILABILITY:"v1/registry/discoverContextAvailability",SUBSCRIBE_CONTEXT_AVAILABILITY:"v1/registry/subscribeContextAvailability",UPDATE_CONTEXT_AVAILABILITY_SUBSCRIPTION:"v1/registry/updateContextAvailabilitySubscription",UNSUBSCRIBE_CONTEXT_AVAILABILITY:"v1/registry/unsubscribeContextAvailability",QUERY_CONTEXT:"v1/queryContext",UPDATE_CONTEXT:"v1/updateContext",SUBSCRIBE_CONTEXT:"v1/subscribeContext",UPDATE_CONTEXT_SUBSCRIPTION:"v1/updateContextSubscription",UNSUBSCRIBE_CONTEXT:"v1/unsubscribeContext",CONTEXT_TYPES:"v1/contextTypes"},v2:{BATCH_QUERY_OP:"v2/op/query",BATCH_UPDATE_OP:"v2/op/update",ENTITY_ATTRS_COLLECTION:"v2/entities/%(entityId)s/attrs",ENTITY_ATTR_ENTRY:"v2/entities/%(entityId)s/attrs/%(attribute)s",ENTITY_ATTR_VALUE_ENTRY:"v2/entities/%(entityId)s/attrs/%(attribute)s/value",ENTITY_COLLECTION:"v2/entities",ENTITY_ENTRY:"v2/entities/%(entityId)s",REGISTRATION_COLLECTION:"v2/registrations",REGISTRATION_ENTRY:"v2/registrations/%(registrationId)s",SUBSCRIPTION_COLLECTION:"v2/subscriptions",SUBSCRIPTION_ENTRY:"v2/subscriptions/%(subscriptionId)s",TYPE_COLLECTION:"v2/types",TYPE_ENTRY:"v2/types/%(typeId)s"},ld:{ENTITY_ATTR_ENTRY:"ngsi-ld/v1/entities/%(entityId)s/attrs/%(attribute)s",ENTITY_COLLECTION:"ngsi-ld/v1/entities",ENTITY_ENTRY:"ngsi-ld/v1/entities/%(entityId)s",ENTITY_ATTRS_COLLECTION:"ngsi-ld/v1/entities/%(entityId)s/attrs",SUBSCRIPTION_COLLECTION:"ngsi-ld/v1/subscriptions",SUBSCRIPTION_ENTRY:"ngsi-ld/v1/subscriptions/%(subscriptionId)s",TEMPORAL_ENTITY_ATTRS_COLLECTION:"ngsi-ld/v1/temporal/entities/%(entityId)s/attrs",TEMPORAL_ENTITY_ATTRS_ENTRY:"ngsi-ld/v1/temporal/entities/%(entityId)s/attrs/%(attribute)s",TEMPORAL_ENTITY_ATTRS_INSTANCE_ENTRY:"ngsi-ld/v1/temporal/entities/%(entityId)s/attrs/%(attribute)s/%(instanceId)s",TEMPORAL_ENTITY_COLLECTION:"ngsi-ld/v1/temporal/entities",TEMPORAL_ENTITY_ENTRY:"ngsi-ld/v1/temporal/entities/%(entityId)s",TYPE_COLLECTION:"ngsi-ld/v1/types",TYPE_ENTRY:"ngsi-ld/v1/types/%(typeId)s"}},e.proxy_endpoints={EVENTSOURCE_COLLECTION:"eventsource",CALLBACK_COLLECTION:"callbacks"};const l=function(e,t){return e.replace(/%\(\w+\)s/g,(function(e){return String(t[e.slice(2,-2)])}))},c=function(t,r,n,o,i){var s,a=null,l=null;null!=r&&(l="application/json",a=JSON.stringify(r)),(s=JSON.parse(JSON.stringify(this.headers))).Accept="application/json",this.makeRequest(t,{method:null!=a?"POST":"GET",contentType:l,requestHeaders:s,parameters:i,postBody:a}).then((function(t){var r;if(200!==t.status)"function"==typeof o.onFailure&&(r=t instanceof e.ConnectionError?t:-1!==[0,502,504].indexOf(t.status)?new e.ConnectionError("Connection Error"):new e.InvalidResponseError("Unexpected error code: "+t.status),o.onFailure(r));else if("function"==typeof o.onSuccess){var i;try{try{i=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content")}i=n(i,o)}catch(e){return"function"==typeof o.onFailure&&o.onFailure(e),void("function"==typeof o.onComplete&&o.onComplete())}o.onSuccess.apply(null,i)}"function"==typeof o.onComplete&&o.onComplete()}),(function(t){if("function"==typeof o.onFailure){t instanceof e.ConnectionError||(t=new e.ConnectionError);try{o.onFailure(t)}catch(e){}}"function"==typeof o.onComplete&&o.onComplete()}))},u=function(e,t){var r=e.trim().toLowerCase(),n=Object.keys(t),o=n.map((function(e){return e.trim().toLowerCase()})).indexOf(r);-1!==o&&delete t[n[o]]},p=function(t,r){null!=r.postBody&&(null==r.contentType&&(r.contentType="application/json"),r.postBody=JSON.stringify(r.postBody));var n=JSON.parse(JSON.stringify(this.headers));for(var o in null==n.Accept&&(n.Accept="application/json"),r.requestHeaders)null!=r.requestHeaders[o]&&(u(o,n),n[o]=r.requestHeaders[o]);return r.requestHeaders=n,this.makeRequest(t,r).then((function(t){return-1!==[0,502,504].indexOf(t.status)?Promise.reject(new e.ConnectionError):Promise.resolve(t)}),(function(t){return t instanceof e.ConnectionError||(t=new e.ConnectionError),Promise.reject(t)}))},d=function(e){var t,r;return r="string"==typeof e.isPattern&&"true"===e.isPattern.trim().toLowerCase()||!0===e.isPattern,t={id:""+e.id,isPattern:""+r},null!=e.type&&(t.type=""+e.type),t},y=function(e){var t,r,n;if("polygon"in e.value){for(t={polygon:{vertices:[]}},r=0;r<e.value.polygon.vertices.length;r++)n=e.value.polygon.vertices[r],t.polygon.vertices.push({latitude:""+n.latitude,longitude:""+n.longitude});e.value.polygon.inverted&&(t.polygon.inverted="true")}else"circle"in e.value&&(t={circle:{centerLatitude:""+e.value.circle.centerLatitude,centerLongitude:""+e.value.circle.centerLongitude,radius:e.value.circle.radius}},e.value.circle.inverted&&(t.circle.inverted="true"));return t},h=function(e){var t,r;if(t={scopes:[]},Array.isArray(e.scopes))for(r=0;r<e.scopes.length;r++)t.scopes.push({type:e.scopes[r].type,value:y(e.scopes[r])});return t},f=function(e){var t,r;for(t=[],r=0;r<e.length;r++)t.push({name:""+e[r].name,type:""+e[r].type,value:""+e[r].value});return t},v=function(e,t,r,n,o){var i,s,a,l;for(i={contextRegistrations:[{entities:[],attributes:[],providingApplication:n}],duration:""+r},s=0;s<e.length;s+=1)i.contextRegistrations[0].entities.push(d(e[s]));for(s=0;s<t.length;s+=1)l={name:(a=t[s]).name,isDomain:"false"},null!=a.type&&(l.type=""+a.type),i.contextRegistrations[0].attributes.push(l);return null!=o&&(i.registrationId=""+o),i},E=function(e,t){var r,n,o,i,s,a,l,c,u;for(r={contextElements:[],updateAction:e},n=0;n<t.length;n+=1){if(i=d(t[n].entity),null!=(a=t[n].attributes))for(s=i.attributes=[],o=0;o<a.length;o+=1)c={name:""+(l=a[o]).name},null!=l.type&&(c.type=""+l.type),"DELETE"!==e&&(u=null!=l.value?l.value:null!=l.contextValue?l.contextValue:null,c.value=u),Array.isArray(l.metadata)&&l.metadata.length>0&&(c.metadatas=f(l.metadata)),s.push(c);r.contextElements.push(i)}return r},T=function(e,t,r,n,o,i){var s,a;for(s=o?{entities:[],subscriptionId:o}:{entities:[],reference:i},a=0;a<e.length;a+=1)s.entities.push(d(e[a]));return Array.isArray(t)&&t.length>0&&(s.attributes=t),null!=r&&(s.duration=""+r),null!=n&&(s.restriction=h(n)),s},m=function(e,t,r,n,o,i,s){var a,l,c,u;if(e)a={subscriptionId:e};else{for(a={entities:[],reference:s},l=0;l<t.length;l+=1)a.entities.push(d(t[l]));Array.isArray(r)&&(a.attributes=r)}if(null!=n&&(a.duration=""+n),Array.isArray(i))for(a.notifyConditions=[],l=0;l<i.length;l+=1)u={type:(c=i[l]).type},a.notifyConditions.push(u),Array.isArray(c.condValues)&&(u.condValues=c.condValues);return null!=o&&(a.throttling=""+o),a},w=function(t){if(N(t),"object"!=typeof t||"string"!=typeof t.registrationId||"string"!=typeof t.duration)throw new e.InvalidResponseError("The server returned an invalid json structure");return[t]},I=function(e){var t,r,n,o=[];for(n=0;n<e.length;n+=1)r={entities:[],attributes:[],providingApplication:(t=e[n].contextRegistration).providingApplication},null!=t.entities&&(r.entities=t.entities),null!=t.attributes&&(r.attributes=t.attributes),o.push(r);return o},g=function(t){if("object"!=typeof t||Array.isArray(t))throw new e.InvalidResponseError("The server returned an invalid json structure");if(N(t),!Array.isArray(t.contextRegistrationResponses))throw new e.InvalidResponseError("The server returned an invalid json structure");return[I(t.contextRegistrationResponses)]},R=function(t){if(N(t),"string"!=typeof t.subscriptionId)throw new e.InvalidResponseError("The server returned an invalid json structure");if("duration"in t&&"string"!=typeof t.duration)throw new e.InvalidResponseError("The server returned an invalid json structure");return[t]},C=function(t){if("object"!=typeof t||Array.isArray(t)||!("subscriptionId"in t))throw new e.InvalidResponseError("The server returned an invalid json structure");return[{subscriptionId:t.subscriptionId,statusCode:P(t)}]},b=function(e,t,r){var n,o,i,s,a,l,c,u,p,d,y;for(c=(i=!!r.flat)?{}:[],y=[],t&&(l=""),s=0;s<e.length;s+=1){if(n=e[s].contextElement,o=i?{}:{entity:null,attributes:[]},200===(d=P(e[s])).code&&i?(o.id=n.id,o.type=n.type):o.entity={id:n.id,type:n.type},null!=n.attributes)for(a=0;a<n.attributes.length;a+=1)u=n.attributes[a],t||(l=u.value),i?o[u.name]=l:(p={name:u.name,type:u.type},t||(p.value=l),null!=u.metadatas&&(p.metadata=u.metadatas),o.attributes.push(p));200===d.code?i?c[n.id]=o:c.push(o):(t&&(o.statusCode=d),y.push(o))}return[c,y]},A=function(t,r){var n,o,i;if(404===(o=P(t)).code){if("string"==typeof o.details&&(n=o.details.match(x))&&(i=o.details={text:o.details,matches:parseInt(n[1]),offset:parseInt(n[2])}),r.details&&(i={count:0}),0!==r.offset)throw o;return[[],i]}if(200!==o.code)throw new e.InvalidResponseError("Unexpected error code");return"string"==typeof o.details&&(n=o.details.match(O))&&(i={count:parseInt(n[1],10)}),[t.types,i]},S=function(t){var r;if("object"!=typeof t||Array.isArray(t))throw new e.InvalidResponseError("The server returned an invalid json structure");if(404===(r=P(t)).code)throw new e.NotFoundError({details:t,message:r.reasonPhrase});if(200!==r.code)throw new e.InvalidResponseError("Unexpected error code");return delete t.statusCode,[t]},P=function(t){if(!("statusCode"in t))throw new e.InvalidResponseError("missing response status code info");return t.statusCode.code=parseInt(t.statusCode.code,10),t.statusCode},N=function(t){if("errorCode"in t)throw new e.InvalidRequestError(parseInt(t.errorCode.code,10),t.errorCode.reasonPhrase,t.errorCode.details)},O=new RegExp("Count: (\\d+)"),x=new RegExp("Number of matching entities: (\\d+). Offset is (\\d+)"),_=function(t,r){var n,o,i;if("object"!=typeof t||Array.isArray(t))throw new e.InvalidResponseError("The server returned an invalid json structure");try{N(t)}catch(e){switch(e.code){case 200:(o=e.details.match(O))&&(n={count:parseInt(o[1],10)});break;case 404:if(i=r.flat?{}:[],(o=e.details.match(x))?n=e.details={text:e.details,matches:parseInt(o[1]),offset:parseInt(o[2])}:!0===r.details&&0===r.offset&&(n=e.details={count:0}),0!==r.offset)throw e;return[i,n];default:throw e}}if(!Array.isArray(t.contextResponses))throw new e.InvalidResponseError("The server returned an invalid json structure");return[b(t.contextResponses,!1,r)[0],n]},L=function(e,t){return N(e),b(e.contextResponses,!0,t)},j=function(t){if(N(t),"string"!=typeof t.subscriptionId)throw new e.InvalidResponseError("The server returned an invalid json structure");if("duration"in t&&"string"!=typeof t.duration)throw new e.InvalidResponseError("The server returned an invalid json structure");if("throttling"in t&&"string"!=typeof t.throttling)throw new e.InvalidResponseError("The server returned an invalid json structure");return t},U=function(t){if(N(t),"object"!=typeof t||"object"!=typeof t.subscribeResponse)throw new e.InvalidResponseError("The server returned an invalid json structure");return[j(t.subscribeResponse)]},F=function(t){if(N(t),"object"!=typeof t||"object"!=typeof t.subscribeResponse)throw new e.InvalidResponseError("The server returned an invalid json structure");return[j(t.subscribeResponse)]},k=function(t){if(N(t),"object"!=typeof t||"string"!=typeof t.subscriptionId)throw new e.InvalidResponseError("The server returned an invalid json structure");return t.statusCode=P(t),[t]},H=function(e,t){var r={};if(null!=e.limit){if("number"!=typeof e.limit||e.limit<20)throw new TypeError("invalid value for the limit option");r.limit=e.limit}if(null!=e.offset){if("number"!=typeof e.offset||e.offset<0)throw new TypeError("invalid value for the offset option");r.offset=e.offset}else e.offset=0;if(null!=t)if(null!=e.details){if("boolean"!=typeof e.details)throw new TypeError("invalid value for the details option");e.details?r.details="on":r.details="off"}else r.details=t,e.details="on"===t;return r},q=function(e,t){const r={},n=null==t;if(null!=e.limit){if("number"!=typeof e.limit||!Number.isInteger(e.limit)||e.limit<(n?0:1))throw new TypeError("invalid value for the limit option");r.limit=e.limit}else e.limit=20;if(null!=e.offset){if("number"!=typeof e.offset||!Number.isInteger(e.offset)||e.offset<0)throw new TypeError("invalid value for the offset option");r.offset=e.offset}else e.offset=0;if(null!=e.count){if("boolean"!=typeof e.count)throw new TypeError("invalid value for the count option");n?r.count=e.count:t.push("count")}return r},Y=function(e){if(-1===["application/json","application/ld+json"].indexOf(e.getHeader("Content-Type")))throw new TypeError("Unexpected response mimetype: "+e.getHeader("Content-Type"));return JSON.parse(e.responseText)},B=function(t,r){try{var n=Y(t)}catch(t){return Promise.reject(new e.InvalidResponseError(null,r))}return Promise.reject(new e.BadRequestError({message:n.description,correlator:r}))},D=function(t,r){try{var n=Y(t)}catch(t){return Promise.reject(new e.InvalidResponseError(null,r))}return Promise.reject(new e.NotFoundError({message:n.description,correlator:r}))},W=function(t,r){try{var n=Y(t)}catch(t){return Promise.reject(new e.InvalidResponseError(null,r))}return Promise.reject(new e.TooManyResultsError({message:n.description,correlator:r}))},V=function(t){let r;try{r=Y(t)}catch(t){return Promise.reject(new e.InvalidResponseError)}return Promise.reject(new e.NotFoundError({message:r.title,details:r.detail}))},G=function(t){let r,n;try{r=Y(t)}catch(t){return Promise.reject(new e.InvalidResponseError(t.toString()))}return n="https://uri.etsi.org/ngsi-ld/errors/InvalidRequest"===r.type?new e.InvalidRequestError(void 0,r.title,r.detail):new e.BadRequestError({message:r.title,details:r.detail}),Promise.reject(n)},J=function(e,t,r){if(t=null==t||!!t,Array.isArray(e)){if(!t&&0===e.length)throw new TypeError(`invalid empty array value for the ${r} option`);return e.length>0?e.join(","):void 0}if(null!=e){if(e=e.toString().trim(),!t&&""===e)throw new TypeError(`invalid empty value for the ${r} option`);return e}};e.parseNotifyContextRequest=function(e,t){return{elements:b(e.contextResponses,!1,t)[0],subscriptionId:e.subscriptionId,originator:e.originator}};const X=function(){return this.makeRequest(new r(e.proxy_endpoints.EVENTSOURCE_COLLECTION,this.url),{supportsAccessControl:!0,method:"POST"}).then(function(n){if(-1!==[0,502,504].indexOf(n.status))return t.get(this).promise=null,Promise.reject(new e.ConnectionError);if(201!==n.status)return t.get(this).promise=null,Promise.reject(new e.InvalidResponseError("Unexpected error code: "+n.status));var o=t.get(this);try{o.source_url=new r(n.getHeader("Location"))}catch(r){return t.get(this).promise=null,Promise.reject(new e.InvalidResponseError("Invalid/missing Location Header"))}return M.call(this)}.bind(this),function(r){return t.get(this).promise=null,r instanceof e.ConnectionError||(r=new e.ConnectionError),Promise.reject(r)}.bind(this))},M=function(){var r=t.get(this);return new Promise((function(t,n){let o,i,s;const a=function e(n){var s=JSON.parse(n.data);clearTimeout(o),r.promise=null,r.connection_id=s.id,r.source.removeEventListener("error",i,!0),r.source.removeEventListener("init",e,!0),r.source.addEventListener("open",()=>{r.promise=null,Object.values(r.callbacks).forEach(e=>{e.method(null,null,!0,"connected")})},!0),r.source.addEventListener("error",e=>{const t=Object.values(r.callbacks);e.target.readyState===e.target.CLOSED?(r.promise=null,r.source=null,r.connection_id=null,r.callbacks={},r.callbacksBySubscriptionId={}):r.promise=Promise.resolve(),t.forEach(t=>{t.method(null,null,!0,e.target.readyState===e.target.CLOSED?"closed":"disconnected")})},!0),r.source.addEventListener("notification",(function(e){var t=JSON.parse(e.data);r.callbacks[t.callback_id].method(t.payload,t.headers,!1,null)}),!0),t()},l=function(t){clearTimeout(o),r.promise=null,r.source.removeEventListener("error",i,!0),r.source.removeEventListener("init",a,!0),r.source.close(),r.source=null,n(new e.ConnectionError(t))};i=l.bind(null,"Connection rejected"),s=l.bind(null,"Connection timeout"),r.source=new EventSource(r.source_url),r.source.addEventListener("error",i,!0),r.source.addEventListener("init",a,!0),o=setTimeout(s,3e4)}))},Q=function(){var e={},r=t.get(this).callbacks;for(var n in r)e[n]=null!=r[n].subscription?r[n].subscription.id:null;return e},K=function(){var e={},r=t.get(this).callbacks;for(var n in r)e[n]=r[n].subscription;return e},$=function(){var e=t.get(this);return null!=e.source&&null!=e.connection_id},z=function(){return null!==t.get(this).promise},Z=function(){return t.get(this).connection_id},ee=function(){var e={},r=t.get(this).callbacksBySubscriptionId;for(var n in r)e[n]=r[n].callback_id;return e};e.ProxyConnection=function(e,n){try{e=new r(e)}catch(e){throw new TypeError("invalid url parameter")}if("http:"!==e.protocol&&"https:"!==e.protocol)throw new TypeError("unsupported protocol: "+e.protocol.substr(0,e.protocol.length-1));"/"!==e.pathname[e.pathname.length-1]&&(e.pathname+="/"),this.makeRequest=n,t.set(this,{callbacks:{},callbacksBySubscriptionId:{},connection_id:null,promise:null,source:null}),Object.defineProperties(this,{callbackSubscriptions:{get:Q},callbackSubscriptionsVersioned:{get:K},connected:{get:$},connecting:{get:z},connection_id:{get:Z},subscriptionCallbacks:{get:ee},url:{value:e}})},e.ProxyConnection.prototype.connect=function(){if(!0===this.connected)return Promise.resolve();var e=t.get(this);return null===e.promise&&(e.promise=X.call(this)),e.promise},e.ProxyConnection.prototype.requestCallback=function(n){if("function"!=typeof n)throw new TypeError("callback parameter must be a function");return this.connect().then(function(){return this.makeRequest(new r(e.proxy_endpoints.CALLBACK_COLLECTION,this.url),{supportsAccessControl:!0,method:"POST",contentType:"application/json",postBody:JSON.stringify({connection_id:this.connection_id})}).then(function(r){if(-1===[200,201].indexOf(r.status))return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+r.status));var o=JSON.parse(r.responseText);return t.get(this).callbacks[o.callback_id]={callback_id:o.callback_id,method:n,subscription:null},Promise.resolve(o)}.bind(this),(function(t){return t instanceof e.ConnectionError||(t=new e.ConnectionError),Promise.reject(t)}))}.bind(this))},e.ProxyConnection.prototype.close=function(r){if(!1===this.connected)return Promise.resolve();!1!==r&&(r=!0);var n=t.get(this);return this.makeRequest(n.source_url,{supportsAccessControl:!0,method:"DELETE",asynchronous:r}).then(function(t){if(204!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));n.source.close(),n.source=null,n.connection_id=null,n.callbacks={},n.callbacksBySubscriptionId={}}.bind(this),(function(t){return t instanceof e.ConnectionError||(t=new e.ConnectionError),Promise.reject(t)}))},e.ProxyConnection.prototype.closeCallback=function(t){return this.makeRequest(new r(e.proxy_endpoints.CALLBACK_COLLECTION+"/"+t,this.url),{supportsAccessControl:!0,method:"DELETE"}).then(function(r){if(204!==r.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+r.status));this.purgeCallback(t)}.bind(this),(function(t){return t instanceof e.ConnectionError||(t=new e.ConnectionError),Promise.reject(t)}))},e.ProxyConnection.prototype.associateSubscriptionId=function(e,r,n){var o=t.get(this);if(!(e in o.callbacks))return this;if(null!=o.callbacks[e].subscription)throw new TypeError("Already associated callback");return o.callbacksBySubscriptionId[r]=o.callbacks[e],o.callbacks[e].subscription={id:r,version:n},this},e.ProxyConnection.prototype.closeSubscriptionCallback=function(e){var r=t.get(this);return e in r.callbacksBySubscriptionId?this.closeCallback(r.callbacksBySubscriptionId[e].callback_id):Promise.resolve()},e.ProxyConnection.prototype.purgeCallback=function(e){var r=t.get(this);if(e in r.callbacks){var n=r.callbacks[e].subscription;null!=n&&delete r.callbacksBySubscriptionId[n.id],delete r.callbacks[e]}},e.Error=class extends Error{constructor(e,t){super(t),this.name=e,this.message=t||"",Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},e.ConnectionError=class extends e.Error{constructor(e){super("ConnectionError",e||"Connection Error")}},e.InvalidRequestError=class extends e.Error{constructor(e,t,r){super("InvalidRequest",t),this.code=e,this.details=r||""}},e.AlreadyExistsError=class extends e.Error{constructor(e){super("AlreadyExists",e.message),this.correlator=e.correlator||null}},e.BadRequestError=class extends e.Error{constructor(e){super("BadRequest",e.message),this.details=e.details||"",this.correlator=e.correlator||null}},e.InvalidResponseError=class extends e.Error{constructor(e,t){super("InvalidResponse",e),this.correlator=t}},e.NotFoundError=class extends e.Error{constructor(e){super("NotFound",e.message),this.details=e.details||"",this.correlator=e.correlator||null}},e.TooManyResultsError=class extends e.Error{constructor(e){super("TooManyResults",e.message),this.correlator=e.correlator||null}},e.ProxyConnectionError=class extends e.Error{constructor(e){super("ProxyConnectionError",e),this.cause=e}},e.Connection=function(t,n){try{t=new r(t)}catch(e){throw new TypeError("invalid url parameter")}if("http:"!==t.protocol&&"https:"!==t.protocol)throw new TypeError("unsupported protocol: "+t.protocol.substr(0,t.protocol.length-1));"/"!==t.pathname[t.pathname.length-1]&&(t.pathname+="/"),null==n&&(n={}),null!=n.headers&&"object"==typeof n.headers?this.headers=n.headers:null!=n.request_headers?this.headers=n.request_headers:this.headers={},null!=n.service&&(u("FIWARE-Service",this.headers),this.headers["FIWARE-Service"]=n.service),null!=n.servicepath&&(u("FIWARE-ServicePath",this.headers),this.headers["FIWARE-ServicePath"]=n.servicepath),"function"==typeof n.requestFunction?this.makeRequest=n.requestFunction:this.makeRequest=a,n.ngsi_proxy_connection instanceof e.ProxyConnection?this.ngsi_proxy=n.ngsi_proxy_connection:"string"==typeof n.ngsi_proxy_url&&(this.ngsi_proxy=new e.ProxyConnection(n.ngsi_proxy_url,this.makeRequest)),Object.defineProperties(this,{url:{value:t},v1:{value:this},v2:{value:new e.Connection.V2(this)},ld:{value:new e.Connection.LD(this)}})},e.Connection.prototype.getServerDetails=function(t){null==t&&(t={});var n=new r(e.endpoints.SERVER_DETAILS,this.url);return p.call(this,n,{method:"GET",requestHeaders:{"FIWARE-Correlator":t.correlator}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content",r))}var o={details:n,correlator:r};return Promise.resolve(o)}))},e.Connection.prototype.createRegistration=function(t,n,o,i,s){if(!Array.isArray(t)||0===t.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=n&&!Array.isArray(n))throw new TypeError("attributes parameter must be an array or null");null==n&&(n=[]),null==s&&(s={});var a=v(t,n,o,i),l=new r(e.endpoints.v1.REGISTER_CONTEXT,this.url);c.call(this,l,a,w,s)},e.Connection.prototype.updateRegistration=function(t,n,o,i,s,a){if(!Array.isArray(n)||0===n.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=o&&!Array.isArray(o))throw new TypeError("attributes parameter must be an array or null");null==o&&(o=[]),null==a&&(a={});var l=v(n,o,i,s,t),u=new r(e.endpoints.v1.REGISTER_CONTEXT,this.url);return c.call(this,u,l,w,a)},e.Connection.prototype.cancelRegistration=function(e,t){if(null==e)throw new TypeError("regId parameter cannot be null");this.updateRegistration(e,[{id:"canceled registration"}],[],"PT0H","http://canceled.registration.com",t)},e.Connection.prototype.discoverAvailability=function(t,n,o){if(!Array.isArray(t)||0===t.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=n&&!Array.isArray(n))throw new TypeError("attributeNames parameter must be an array or null");null==n&&(n=[]),null==o&&(o={});var i=function(e,t){var r,n;for(r={entities:[],attributes:t},n=0;n<e.length;n+=1)r.entities.push(d(e[n]));return r}(t,n),s=new r(e.endpoints.v1.DISCOVER_CONTEXT_AVAILABILITY,this.url);c.call(this,s,i,g,o)},e.Connection.prototype.createAvailabilitySubscription=function(t,n,o,i,s){if(!Array.isArray(t)||0===t.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=n&&!Array.isArray(n))throw new TypeError("attributeNames parameter must be an array or null");if(null==s)throw new TypeError("Missing options parameter");if("string"!=typeof s.onNotify&&"function"!=typeof s.onNotify)throw new TypeError("Invalid onNotify callback");if("function"==typeof s.onNotify&&null==this.ngsi_proxy)throw new TypeError("A ngsi-proxy is needed for using local onNotify callbacks");var a=new r(e.endpoints.v1.SUBSCRIBE_CONTEXT_AVAILABILITY,this.url);if("function"==typeof s.onNotify&&null!=this.ngsi_proxy){this.ngsi_proxy.requestCallback((function(t){var r=function(t,r){if("object"!=typeof t||Array.isArray(t)||!Array.isArray(t.contextRegistrationResponses))throw new e.InvalidResponseError("The server returned an invalid json structure");return[I(t.contextRegistrationResponses)]}(JSON.parse(t));s.onNotify(r)})).then(function(e){var r=T(t,n,o,i,null,e.url),l=s.onFailure;s.onFailure=function(){this.ngsi_proxy.closeCallback(e.callback_id),"function"==typeof l&&l.apply(this,arguments)}.bind(this);var u=s.onSuccess;s.onSuccess=function(t){this.ngsi_proxy.associateSubscriptionId(e.callback_id,t.subscriptionId,"v1-availability"),"function"==typeof u&&u(t)}.bind(this),c.call(this,a,r,R,s)}.bind(this),(function(){"function"==typeof s.onFailure&&s.onFailure()}))}else{var l=T(t,n,o,i,null,s.onNotify);c.call(this,a,l,R,s)}},e.Connection.prototype.updateAvailabilitySubscription=function(t,n,o,i,s,a){if(null==t)throw new TypeError("subId parameter cannot be null");if(!Array.isArray(n)||0===n.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=o&&!Array.isArray(o))throw new TypeError("attributeNames parameter must be an array or null");null==a&&(a={});var l=T(n,o,i,s,t),u=new r(e.endpoints.v1.UPDATE_CONTEXT_AVAILABILITY_SUBSCRIPTION,this.url);c.call(this,u,l,R,a)},e.Connection.prototype.cancelAvailabilitySubscription=function(t,n){if(null==t)throw new TypeError("subId parameter cannot be null");null==n&&(n={});var o=function(e){return{subscriptionId:e}}(t),i=new r(e.endpoints.v1.UNSUBSCRIBE_CONTEXT_AVAILABILITY,this.url);c.call(this,i,o,C,n)},e.Connection.prototype.query=function(t,n,o){var i,s,a;if(!Array.isArray(t)||0===t.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=n&&!Array.isArray(n))throw new TypeError("attributesName must be null or an array");null==n&&(n=[]),null==o&&(o={}),s=H(o,"off"),i=new r(e.endpoints.v1.QUERY_CONTEXT,this.url),a=function(e,t,r){var n,o;for(n={entities:[]},o=0;o<e.length;o+=1)n.entities.push(d(e[o]));if(Array.isArray(t)&&t.length>0)for(n.attributes=[],o=0;o<t.length;o+=1)n.attributes.push(""+t[o]);return null!=r&&(n.restriction=h(r)),n}(t,n,o.restriction),c.call(this,i,a,_,o,s)},e.Connection.prototype.updateAttributes=function(t,n){if(!Array.isArray(t)||0===t.length)throw new TypeError("update parameter must be a non-empty array");null==n&&(n={});var o=E("UPDATE",t),i=new r(e.endpoints.v1.UPDATE_CONTEXT,this.url);c.call(this,i,o,L,n)},e.Connection.prototype.addAttributes=function(t,n){if(!Array.isArray(t)||0===t.length)throw new TypeError("toAdd parameter must be a non-empty array");null==n&&(n={});var o=E("APPEND",t),i=new r(e.endpoints.v1.UPDATE_CONTEXT,this.url);c.call(this,i,o,L,n)},e.Connection.prototype.deleteAttributes=function(t,n){if(!Array.isArray(t)||0===t.length)throw new TypeError("toDelete parameter must be a non-empty array");null==n&&(n={});var o=E("DELETE",t),i=new r(e.endpoints.v1.UPDATE_CONTEXT,this.url);c.call(this,i,o,L,n)},e.Connection.prototype.createSubscription=function(t,n,o,i,s,a){if(!Array.isArray(t)||0===t.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=n&&!Array.isArray(n))throw new TypeError("attributeNames parameter must be an array or null");if(null==a)throw new TypeError("Missing options parameter");if("string"!=typeof a.onNotify&&"function"!=typeof a.onNotify)throw new TypeError("Invalid onNotify callback");if("function"==typeof a.onNotify&&null==this.ngsi_proxy)throw new TypeError("A ngsi-proxy is needed for using local onNotify callbacks");var l=new r(e.endpoints.v1.SUBSCRIBE_CONTEXT,this.url);if("function"==typeof a.onNotify&&null!=this.ngsi_proxy){const r=(t,r,n,o)=>{null!=t&&(t=JSON.parse(t),t=e.parseNotifyContextRequest(t,a)),a.onNotify(t,r,n,o)};this.ngsi_proxy.requestCallback(r).then(function(e){var r=m(null,t,n,o,i,s,e.url),u=a.onFailure;a.onFailure=function(){this.ngsi_proxy.closeCallback(e.callback_id).catch((function(e){console.log("Error closing callback on the ngsi-proxy")})),"function"==typeof u&&u.apply(this,arguments)}.bind(this);var p=a.onSuccess;a.onSuccess=function(t){this.ngsi_proxy.associateSubscriptionId(e.callback_id,t.subscriptionId,"v1"),"function"==typeof p&&p(t)}.bind(this),c.call(this,l,r,U,a)}.bind(this),(function(t){if("function"==typeof a.onFailure){var r=new e.ProxyConnectionError(t);try{a.onFailure(r)}catch(e){}}if("function"==typeof a.onComplete)try{a.onComplete()}catch(e){}}))}else{var u=m(null,t,n,o,i,s,a.onNotify);c.call(this,l,u,U,a)}},e.Connection.prototype.updateSubscription=function(t,n,o,i,s){if(null==t)throw new TypeError("subId parameter cannot be null");null==s&&(s={});var a=m(t,null,null,n,o,i),l=new r(e.endpoints.v1.UPDATE_CONTEXT_SUBSCRIPTION,this.url);c.call(this,l,a,F,s)},e.Connection.prototype.cancelSubscription=function(t,n){if(null==t)throw new TypeError("subId parameter cannot be null");if(null==n&&(n={}),this.ngsi_proxy){var o=n.onSuccess;n.onSuccess=function(e){this.ngsi_proxy.closeSubscriptionCallback(e.subscriptionId),"function"==typeof o&&o(e)}.bind(this)}var i=function(e){return{subscriptionId:e}}(t),s=new r(e.endpoints.v1.UNSUBSCRIBE_CONTEXT,this.url);c.call(this,s,i,k,n)},e.Connection.prototype.getAvailableTypes=function(t){var n=new r(e.endpoints.v1.CONTEXT_TYPES,this.url),o=H(t,"on");c.call(this,n,null,A,t,o)},e.Connection.prototype.getTypeInfo=function(t,n){if(null==t)throw new TypeError("Invalid type parameter");var o=new r(e.endpoints.v1.CONTEXT_TYPES+"/"+encodeURIComponent(t),this.url);c.call(this,o,null,S,n)},e.Connection.V2=function(e){t.set(this,e)},e.Connection.V2.prototype.listEntities=function(n){if(null==n&&(n={}),null!=n.id&&null!=n.idPattern)throw new TypeError("id and idPattern options cannot be used at the same time");if(null!=n.type&&null!=n.typePattern)throw new TypeError("type and typePattern options cannot be used at the same time");var o=t.get(this),i=new r(e.endpoints.v2.ENTITY_COLLECTION,o.url),s=[],a=q(n,s);return!0===n.keyValues&&s.push("keyValues"),!0===n.values&&s.push("values"),!0===n.unique&&s.push("unique"),0!==s.length&&(a.options=s.join(",")),a.attrs=J(n.attrs),a.id=J(n.id,!1,"id"),a.idPattern=n.idPattern,a.orderBy=n.orderBy,a.metadata=J(n.metadata),a.mq=n.mq,a.q=n.q,a.type=J(n.type,!1,"type"),a.typePattern=n.typePattern,a.georel=n.georel,a.geometry=n.geometry,a.coords=n.coords,p.call(o,i,{method:"GET",parameters:a,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var o=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content",r))}var i={results:o,limit:n.limit,offset:n.offset,correlator:r};return!0===n.count&&(i.count=parseInt(t.getHeader("Fiware-Total-Count"),10)),Promise.resolve(i)}))},e.Connection.V2.prototype.createEntity=function(n,o){if(null==o&&(o={}),null==n.id)throw new TypeError("missing entity id");var i=t.get(this),s={};!0===o.keyValues&&!0===o.upsert?s.options="keyValues,upsert":!0===o.upsert?s.options="upsert":!0===o.keyValues&&(s.options="keyValues");var a=new r(e.endpoints.v2.ENTITY_COLLECTION,i.url);return p.call(i,a,{method:"POST",postBody:n,parameters:s,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):!0!==o.upsert&&422===t.status?Promise.reject(new e.AlreadyExistsError({correlator:r})):!0!==o.upsert&&201!==t.status||!0===o.upsert&&-1===[201,204].indexOf(t.status)?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r,entity:n,location:t.getHeader("Location")})}))},e.Connection.V2.prototype.getEntity=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ENTRY,{entityId:encodeURIComponent(n.id)}),o.url),s={};return null!=n.type&&(s.type=n.type),!0===n.keyValues&&(s.options="keyValues"),p.call(o,i,{method:"GET",parameters:s,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(409===t.status)return W(t,r);if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({correlator:r,entity:n})}))},e.Connection.V2.prototype.getEntityAttributes=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(n.id)}),o.url),s={};return null!=n.type&&(s.type=n.type),!0===n.keyValues&&(s.options="keyValues"),p.call(o,i,{method:"GET",parameters:s,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(409===t.status)return W(t,r);if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({attributes:n,correlator:r})}))},e.Connection.V2.prototype.appendEntityAttributes=function(n,o){null==o&&(o={});var i=t.get(this),s=new r(l(e.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(n.id)}),i.url),a={},c=[];return delete n.id,null!=n.type?(a.type=n.type,delete n.type):null!=o.type&&(a.type=o.type),!0===o.strict&&c.push("append"),!0===o.keyValues&&c.push("keyValues"),c.length>0&&(a.options=c.join(",")),p.call(i,s,{method:"POST",parameters:a,postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.updateEntityAttributes=function(n,o){if(null==o&&(o={}),null==n)throw new TypeError("missing changes parameter");var i=t.get(this),s=new r(l(e.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(n.id)}),i.url),a={};return delete n.id,null!=n.type&&(a.type=n.type,delete n.type),!0===o.keyValues&&(a.options="keyValues"),p.call(i,s,{method:"PATCH",parameters:a,postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.replaceEntityAttributes=function(n,o){null==o&&(o={});var i=t.get(this),s=new r(l(e.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(n.id)}),i.url),a={},c=function(e,t,r){return null!=e.type&&(r.type=e.type,delete e.type),!0===t.keyValues&&(r.options="keyValues"),delete e.id,e}(n,o,a);return p.call(i,s,{method:"PUT",postBody:c,parameters:a,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r,entity:n})}))},e.Connection.V2.prototype.deleteEntity=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ENTRY,{entityId:encodeURIComponent(n.id)}),o.url),s={};return null!=n.type&&(s.type=n.type),p.call(o,i,{method:"DELETE",parameters:s,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.getEntityAttribute=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute)}),o.url),s={};return null!=n.type&&(s.type=n.type),p.call(o,i,{method:"GET",parameters:s,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(409===t.status)return W(t,r);if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status),r);try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({correlator:r,attribute:n})}))},e.Connection.V2.prototype.replaceEntityAttribute=function(n,o){if(null==n)throw new TypeError("missing changes parameter");if(null==o&&(o={attribute:n.attribute,correlator:n.correlator,id:n.id,service:n.service,servicepath:n.servicepath,type:n.type}),null==o.id)throw new TypeError("missing id option");if(null==o.attribute)throw new TypeError("missing attribute option");var i={value:n.value,metadata:n.metadata},s=t.get(this),a=new r(l(e.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(o.id),attribute:encodeURIComponent(o.attribute)}),s.url),c={};return null!=o.type&&(c.type=o.type),p.call(s,a,{method:"PUT",parameters:c,postBody:i,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r,attribute:i})}))},e.Connection.V2.prototype.deleteEntityAttribute=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute)}),o.url),s={};return null!=n.type&&(s.type=n.type),p.call(o,i,{method:"DELETE",parameters:s,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.getEntityAttributeValue=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ATTR_VALUE_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute)}),o.url),s={};return null!=n.type&&(s.type=n.type),p.call(o,i,{method:"GET",parameters:s,requestHeaders:{Accept:"application/json, text/plain","FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(409===t.status)return W(t,r);if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({correlator:r,value:n})}))},e.Connection.V2.prototype.replaceEntityAttributeValue=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");if(void 0===n.value)throw new TypeError("missing value option");var o=t.get(this),i=new r(l(e.endpoints.v2.ENTITY_ATTR_VALUE_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute)}),o.url),s={};return null!=n.type&&(s.type=n.type),p.call(o,i,{method:"PUT",parameters:s,postBody:n.value,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):409===t.status?W(t,r):404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r,value:n.value})}))},e.Connection.V2.prototype.listTypes=function(n){null==n&&(n={});var o=t.get(this),i=new r(e.endpoints.v2.TYPE_COLLECTION,o.url),s=[],a=q(n,s);return!0===n.values&&s.push("values"),0!==s.length&&(a.options=s.join(",")),p.call(o,i,{method:"GET",parameters:a,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));var o={correlator:r,limit:n.limit,offset:n.offset,results:JSON.parse(t.responseText)};return!0===n.count&&(o.count=parseInt(t.getHeader("Fiware-Total-Count"),10)),Promise.resolve(o)}))},e.Connection.V2.prototype.getType=function(n){if(null==n)throw new TypeError("missing options parameter");"string"==typeof n&&(n={id:n});var o=t.get(this),i=new r(l(e.endpoints.v2.TYPE_ENTRY,{typeId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"GET",requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({correlator:r,type:n})}))},e.Connection.V2.prototype.listSubscriptions=function(n){null==n&&(n={});var o=t.get(this),i=new r(e.endpoints.v2.SUBSCRIPTION_COLLECTION,o.url),s=[],a=q(n,s);return 0!==s.length&&(a.options=s.join(",")),p.call(o,i,{method:"GET",parameters:a,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));var o={correlator:r,limit:n.limit,offset:n.offset,results:JSON.parse(t.responseText)};return!0===n.count&&(o.count=parseInt(t.getHeader("Fiware-Total-Count"),10)),Promise.resolve(o)}))},e.Connection.V2.prototype.createSubscription=function(n,o){var i,s,a=t.get(this);if(null==o&&(o={}),"object"!=typeof n)throw new TypeError("invalid subscription parameter");if("callback"in n.notification){if("function"!=typeof n.notification.callback)throw new TypeError("invalid callback configuration");const e=n.notification.callback,t=(t,r,n,o)=>{null!=t&&((t=JSON.parse(t)).attrsformat=r["ngsiv2-attrsformat"]),e(t,r,n,o)};i=a.ngsi_proxy.requestCallback(t).then((function(e){s=e,delete n.notification.callback,n.notification.http={url:s.url}}))}else i=Promise.resolve();var l={};!0===o.skipInitialNotification&&(l.options="skipInitialNotification");var c=new r(e.endpoints.v2.SUBSCRIPTION_COLLECTION,a.url);return i.then((function(){return p.call(a,c,{method:"POST",postBody:n,parameters:l,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}})})).then(function(t){var o=t.getHeader("Fiware-correlator");if(400===t.status)return B(t,o);if(201!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,o));var i=t.getHeader("Location");try{var l=new r(i,a.url).pathname.split("/").pop();n.id=l}catch(t){return Promise.reject(new e.InvalidResponseError("Unexpected location header: "+i,o))}return s&&this.ngsi_proxy.associateSubscriptionId(s.callback_id,l,"v2"),Promise.resolve({correlator:o,subscription:n,location:i})}.bind(a),function(e){return s&&this.ngsi_proxy.closeCallback(s.callback_id),Promise.reject(e)}.bind(a))},e.Connection.V2.prototype.getSubscription=function(n){if(null==n)throw new TypeError("missing options parameter");"string"==typeof n&&(n={id:n});var o=t.get(this),i=new r(l(e.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"GET",requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({correlator:r,subscription:n})}))},e.Connection.V2.prototype.updateSubscription=function(n,o){null==o&&(o={});var i=t.get(this),s=new r(l(e.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(n.id)}),i.url);return delete n.id,p.call(i,s,{method:"PATCH",postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.deleteSubscription=function(n){if(null==n)throw new TypeError("missing options parameter");"string"==typeof n&&(n={id:n});var o=t.get(this),i=new r(l(e.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"DELETE",requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.listRegistrations=function(n){null==n&&(n={});var o=t.get(this),i=new r(e.endpoints.v2.REGISTRATION_COLLECTION,o.url),s=[],a=q(n,s);return 0!==s.length&&(a.options=s.join(",")),p.call(o,i,{method:"GET",parameters:a,requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));var o={correlator:r,limit:n.limit,offset:n.offset,results:JSON.parse(t.responseText)};return!0===n.count&&(o.count=parseInt(t.getHeader("Fiware-Total-Count"),10)),Promise.resolve(o)}))},e.Connection.V2.prototype.createRegistration=function(n,o){if(null==o&&(o={}),"object"!=typeof n||Array.isArray(n))throw new TypeError("invalid registration parameter");var i=t.get(this),s=new r(e.endpoints.v2.REGISTRATION_COLLECTION,i.url);return p.call(i,s,{method:"POST",postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var o=t.getHeader("Fiware-correlator");if(400===t.status)return B(t,o);if(201!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,o));var s=t.getHeader("Location");try{var a=new r(s,i.url).pathname.split("/").pop();n.id=a}catch(t){return Promise.reject(new e.InvalidResponseError("Unexpected location header: "+s,o))}return Promise.resolve({correlator:o,registration:n,location:s})}))},e.Connection.V2.prototype.getRegistration=function(n){if(null==n)throw new TypeError("missing options parameter");"string"==typeof n&&(n={id:n});var o=t.get(this),i=new r(l(e.endpoints.v2.REGISTRATION_ENTRY,{registrationId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"GET",requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(404===t.status)return D(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content",r)}return Promise.resolve({correlator:r,registration:n})}))},e.Connection.V2.prototype.updateRegistration=function(n,o){null==o&&(o={});var i=t.get(this),s=new r(l(e.endpoints.v2.REGISTRATION_ENTRY,{registrationId:encodeURIComponent(n.id)}),i.url);return delete n.id,p.call(i,s,{method:"PATCH",postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.deleteRegistration=function(n){if(null==n)throw new TypeError("missing options parameter");"string"==typeof n&&(n={id:n});var o=t.get(this),i=new r(l(e.endpoints.v2.REGISTRATION_ENTRY,{registrationId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"DELETE",requestHeaders:{"FIWARE-Correlator":n.correlator,"FIWARE-Service":n.service,"FIWARE-ServicePath":n.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 404===t.status?D(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.batchUpdate=function(n,o){if(null==o&&(o={}),null==n)throw new TypeError("missing changes parameter");var i=t.get(this),s=new r(l(e.endpoints.v2.BATCH_UPDATE_OP),i.url),a={};return!0===o.keyValues&&(a.options="keyValues"),p.call(i,s,{method:"POST",parameters:a,postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");return 400===t.status?B(t,r):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r)):Promise.resolve({correlator:r})}))},e.Connection.V2.prototype.batchQuery=function(n,o){null==o&&(o={}),null==n?n={entities:[]}:null==n.entities&&null==n.attributes&&(n.entities=[]);var i=t.get(this),s=new r(e.endpoints.v2.BATCH_QUERY_OP,i.url),a=[],l=q(o,a);return!0===o.keyValues&&a.push("keyValues"),!0===o.values&&a.push("values"),!0===o.unique&&a.push("unique"),a.length>0&&(l.options=a.join(",")),l.orderBy=o.orderBy,p.call(i,s,{method:"POST",parameters:l,postBody:n,requestHeaders:{"FIWARE-Correlator":o.correlator,"FIWARE-Service":o.service,"FIWARE-ServicePath":o.servicepath}}).then((function(t){var r=t.getHeader("Fiware-correlator");if(400===t.status)return B(t,r);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status,r));try{var n=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content",r))}var i={correlator:r,limit:o.limit,offset:o.offset,results:n};return!0===o.count&&(i.count=parseInt(t.getHeader("Fiware-Total-Count"),10)),Promise.resolve(i)}))},e.Connection.LD=function(e){t.set(this,e)},e.Connection.LD.prototype.queryEntities=function(n){if(null==n&&(n={}),null!=n.id&&null!=n.idPattern)throw new TypeError("id and idPattern options cannot be used at the same time");null==n.id&&null==n.idPattern&&null==n.type&&(n.idPattern=".*");const o=t.get(this),i=new r(e.endpoints.ld.ENTITY_COLLECTION,o.url),s=q(n,null),a=[];!0===n.keyValues&&a.push("keyValues"),!0===n.sysAttrs&&a.push("sysAttrs"),0!==a.length&&(s.options=a.join(",")),s.attrs=J(n.attrs,!0),s.csf=n.csf,s.id=J(n.id,!1,"id"),s.idPattern=n.idPattern,s.q=n.q,s.type=J(n.type,!1,"type"),s.geoproperty=n.geoproperty,s.georel=n.georel,s.geometry=n.geometry,s.coordinates=n.coordinates;const l={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(l.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",parameters:s,requestHeaders:l}).then(t=>{if(400===t.status)return G(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content"))}const o={format:t.getHeader("Content-Type"),limit:n.limit,offset:n.offset,results:r};if(!0===n.count){const e=t.getHeader("NGSILD-Results-Count");o.count=null!=e?parseInt(e,10):null}return Promise.resolve(o)})},e.Connection.LD.prototype.createEntity=function(n,o){if(null==o&&(o={}),null==n.id)throw new TypeError("missing entity id");if(null==n.type)throw new TypeError("missing entity type");const i=t.get(this),s=new r(e.endpoints.ld.ENTITY_COLLECTION,i.url);return p.call(i,s,{method:"POST",postBody:n,contentType:"@context"in n?"application/ld+json":"application/json",requestHeaders:{"NGSILD-Tenant":o.tenant}}).then((function(t){return 400===t.status?G(t):409===t.status?Promise.reject(new e.AlreadyExistsError({})):201!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({entity:n,location:t.getHeader("Location")})}))},e.Connection.LD.prototype.getEntity=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");const o=t.get(this),i=new r(l(e.endpoints.ld.ENTITY_ENTRY,{entityId:encodeURIComponent(n.id)}),o.url),s={attrs:J(n.attrs)};!0===n.keyValues&&(s.options="keyValues");const a={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(a.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",parameters:s,requestHeaders:a}).then((function(t){if(404===t.status)return V(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content")}return Promise.resolve({format:t.getHeader("Content-Type"),entity:r})}))},e.Connection.LD.prototype.deleteEntity=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");const o=t.get(this),i=new r(l(e.endpoints.ld.ENTITY_ENTRY,{entityId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"DELETE",requestHeaders:{"NGSILD-Tenant":n.tenant}}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.listSubscriptions=function(n){null==n&&(n={});const o=t.get(this),i=new r(e.endpoints.ld.SUBSCRIPTION_COLLECTION,o.url),s=q(n,null),a=[];!0===n.sysAttrs&&a.push("sysAttrs"),0!==a.length&&(s.options=a.join(","));const l={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(l.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",parameters:s,requestHeaders:l}).then(t=>{if(400===t.status)return G(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content"))}const o={format:t.getHeader("Content-Type"),limit:n.limit,offset:n.offset,results:r};if(!0===n.count){const e=t.getHeader("NGSILD-Results-Count");o.count=null!=e?parseInt(e,10):null}return Promise.resolve(o)})},e.Connection.LD.prototype.createSubscription=function(n,o){let i,s;const a=t.get(this);if(null==o&&(o={}),"object"!=typeof n)throw new TypeError("invalid subscription parameter");if("Subscription"!==n.type)throw new TypeError("invalid subscription type, it should be 'Subscription' for NGSI-LD v1");if(!Array.isArray(n.entities)&&!Array.isArray(n.watchedAttributes))throw new TypeError("at least one of 'entities' and 'watchedAttributes' must be provided");if(null==n.notification)throw new TypeError("missing notification attribute");if("object"!=typeof n.notification)throw new TypeError("invalid notification attribute");if(null==n.notification.endpoint)throw new TypeError("missing notification.endpoint attribute");if("object"!=typeof n.notification.endpoint)throw new TypeError("invalid notification.endpoint attribute");if("callback"in n.notification.endpoint){if("function"!=typeof n.notification.endpoint.callback)throw new TypeError("invalid callback configuration");const e=n.notification.endpoint.callback,t=n.notification.format||"normalized",r=(r,n,o,i)=>{null!=r&&((r=JSON.parse(r)).format=t,r.contentType=n["content-type"]),e(r,n,o,i)};i=a.ngsi_proxy.requestCallback(r).then(e=>{s=e,delete n.notification.endpoint.callback,n.notification.endpoint.uri=s.url})}else i=Promise.resolve();const l=new r(e.endpoints.ld.SUBSCRIPTION_COLLECTION,a.url);return i.then(()=>p.call(a,l,{method:"POST",contentType:"@context"in n?"application/ld+json":"application/json",postBody:n,requestHeaders:{"NGSILD-Tenant":o.tenant}})).then(t=>{if(400===t.status)return G(t);if(409===t.status)return Promise.reject(new e.AlreadyExistsError({}));if(201!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));const o=t.getHeader("Location");try{const e=new r(o,a.url);n.id=e.pathname.split("/").pop()}catch(t){return Promise.reject(new e.InvalidResponseError("Unexpected location header: "+o))}return s&&a.ngsi_proxy.associateSubscriptionId(s.callback_id,n.id,"ld"),Promise.resolve({subscription:n,location:o})},e=>(s&&a.ngsi_proxy.closeCallback(s.callback_id),Promise.reject(e)))},e.Connection.LD.prototype.deleteSubscription=function(n){if(null==n)throw new TypeError("missing options parameter");"string"==typeof n&&(n={id:n});const o=t.get(this),i=new r(l(e.endpoints.ld.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"DELETE",requestHeaders:{"NGSILD-Tenant":n.tenant}}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.getSubscription=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");const o=t.get(this),i=new r(l(e.endpoints.ld.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(n.id)}),o.url),s={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(s.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",requestHeaders:s}).then(t=>{if(400===t.status)return G(t);if(404===t.status)return V(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content")}return Promise.resolve({format:t.getHeader("Content-Type"),subscription:r})})},e.Connection.LD.prototype.updateSubscription=function(n,o){null==o&&(o={});const i=null!=o.id?o.id:n.id;if(null==i)throw new TypeError("missing subscription id");null!=n.id&&delete n.id;const s=t.get(this),a=new r(l(e.endpoints.ld.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(i)}),s.url),c={Accept:"application/ld+json, application/json","NGSILD-Tenant":o.tenant};return"string"==typeof o["@context"]&&(c.Link="<"+encodeURI(o["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(s,a,{method:"PATCH",contentType:"application/merge-patch+json",postBody:n,requestHeaders:c}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.appendEntityAttributes=function(n,o){if(null==n||"object"!=typeof n)throw new TypeError("changes parameter should be an object");null==o&&(o={});const i=null!=o.id?o.id:n.id;if(null==i)throw new TypeError("missing entity id");null!=n.id&&delete n.id;let s={};!0===o.noOverwrite&&(s.options="noOverwrite");const a=t.get(this),c=new r(l(e.endpoints.ld.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(i)}),a.url),u={"NGSILD-Tenant":o.tenant};return"string"==typeof o["@context"]&&(u.Link="<"+encodeURI(o["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(a,c,{method:"POST",parameters:s,contentType:"application/merge-patch+json",postBody:n,requestHeaders:u}).then(t=>{let r;if(400===t.status)return G(t);if(207===t.status)try{r=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content")}else{if(404===t.status)return V(t);if(204!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status))}return Promise.resolve({updated:r?r.updated:Object.keys(n),notUpdated:r?r.notUpdated:[]})})},e.Connection.LD.prototype.updateEntityAttribute=function(n,o){if(null==n||"object"!=typeof n)throw new TypeError("changes parameter should be an object");null==o&&(o={});const i=o.id;if(null==i)throw new TypeError("missing entity id");const s=o.attribute;if(null==s)throw new TypeError("missing entity attribute to update");const a=t.get(this),c=new r(l(e.endpoints.ld.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(i),attribute:encodeURIComponent(s)}),a.url),u={"NGSILD-Tenant":o.tenant};return"string"==typeof o["@context"]&&(u.Link="<"+encodeURI(o["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(a,c,{method:"PATCH",postBody:n,requestHeaders:u}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.updateEntityAttributes=function(n,o){if(null==n||"object"!=typeof n)throw new TypeError("changes parameter should be an object");null==o&&(o={});const i=null!=o.id?o.id:n.id;if(null==i)throw new TypeError("missing entity id");null!=n.id&&delete n.id;const s=t.get(this),a=new r(l(e.endpoints.ld.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(i)}),s.url);return p.call(s,a,{method:"PATCH",postBody:n,requestHeaders:{"NGSILD-Tenant":o.tenant}}).then(t=>{let r;if(400===t.status)return G(t);if(207===t.status)try{r=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content")}else{if(404===t.status)return V(t);if(204!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status))}return Promise.resolve({updated:r?r.updated:Object.keys(n),notUpdated:r?r.notUpdated:[]})})},e.Connection.LD.prototype.deleteEntityAttribute=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");const o=t.get(this),i=new r(l(e.endpoints.ld.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute)}),o.url),s={datasetId:n.datasetId,deleteAll:n.deleteAll},a={"NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(a.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"DELETE",parameters:s,requestHeaders:a}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.listTypes=function(n){null==n&&(n={});const o=t.get(this),i=new r(e.endpoints.ld.TYPE_COLLECTION,o.url),s=q(n,null);s.details=n.details;const a={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(a.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",parameters:s,requestHeaders:a}).then(t=>{if(400===t.status)return G(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content"))}const o={format:t.getHeader("Content-Type"),limit:n.limit,offset:n.offset,results:r};if(!0===n.count){const e=t.getHeader("NGSILD-Results-Count");o.count=null!=e?parseInt(e,10):null}return Promise.resolve(o)})},e.Connection.LD.prototype.getType=function(n){if("string"==typeof n)n={type:n};else if(null==n)throw new TypeError("missing options parameter");if(null==n.type)throw new TypeError("missing type option");const o=t.get(this),i=new r(l(e.endpoints.ld.TYPE_ENTRY,{typeId:encodeURIComponent(n.type)}),o.url),s={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(s.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",requestHeaders:s}).then(t=>{if(400===t.status)return G(t);if(404===t.status)return V(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){throw new e.InvalidResponseError("Server returned invalid JSON content")}return Promise.resolve({format:t.getHeader("Content-Type"),type:r})})},e.Connection.LD.prototype.queryTemporalEntities=function(n){if(null==n&&(n={}),null!=n.id&&null!=n.idPattern)throw new TypeError("id and idPattern options cannot be used at the same time");if(null==n.attrs&&null==n.type)throw new TypeError("type option is required if attrs option is not provided");if(null==n.timerel&&(n.timerel="before"),null==n.timeAt&&(n.timeAt=new Date),"between"===n.timerel&&null==n.endTimeAt)throw new TypeError('endTimeAt option is required if timerel is equal to "between"');const o=t.get(this),i=new r(e.endpoints.ld.TEMPORAL_ENTITY_COLLECTION,o.url),s=q(n,null),a=[];!0===n.temporalValues&&a.push("temporalValues"),0!==a.length&&(s.options=a.join(",")),s.attrs=J(n.attrs,!1,"attrs"),s.endTimeAt=null!=n.endTimeAt?"function"==typeof n.endTimeAt.toISOString?n.endTimeAt.toISOString():n.endTimeAt:void 0,s.csf=n.csf,s.id=J(n.id,!1,"id"),s.idPattern=n.idPattern,s.lastN=n.lastN,s.q=n.q,s.timeAt="function"==typeof n.timeAt.toISOString?n.timeAt.toISOString():n.timeAt,s.timerel=n.timerel,s.timeproperty=n.timeproperty,s.type=J(n.type,!1,"type"),s.geoproperty=n.geoproperty,s.georel=n.georel,s.geometry=n.geometry,s.coordinates=n.coordinates;const l={Accept:"application/ld+json, application/json","NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(l.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"GET",parameters:s,requestHeaders:l}).then(t=>{if(400===t.status)return G(t);if(200!==t.status)return Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status));let r;try{r=JSON.parse(t.responseText)}catch(t){return Promise.reject(new e.InvalidResponseError("Server returned invalid JSON content"))}const o={format:t.getHeader("Content-Type"),limit:n.limit,offset:n.offset,results:r};if(!0===n.count){const e=t.getHeader("NGSILD-Results-Count");o.count=null!=e?parseInt(e,10):null}return Promise.resolve(o)})},e.Connection.LD.prototype.createTemporalEntity=function(n,o){if(null==o&&(o={}),null==n.id)throw new TypeError("missing entity id");if(null==n.type)throw new TypeError("missing entity type");const i=t.get(this),s=new r(e.endpoints.ld.TEMPORAL_ENTITY_COLLECTION,i.url);return p.call(i,s,{method:"POST",postBody:n,contentType:"@context"in n?"application/ld+json":"application/json",requestHeaders:{"NGSILD-Tenant":o.tenant}}).then(t=>400===t.status?G(t):409===t.status?Promise.reject(new e.AlreadyExistsError({})):-1===[201,204].indexOf(t.status)?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({entity:n,created:201===t.status,location:t.getHeader("Location")}))},e.Connection.LD.prototype.deleteTemporalEntity=function(n){if(null==n)throw new TypeError("missing options parameter");if("string"==typeof n)n={id:n};else if(null==n.id)throw new TypeError("missing id option");const o=t.get(this),i=new r(l(e.endpoints.ld.TEMPORAL_ENTITY_ENTRY,{entityId:encodeURIComponent(n.id)}),o.url);return p.call(o,i,{method:"DELETE",requestHeaders:{"NGSILD-Tenant":n.tenant}}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.addTemporalEntityAttributes=function(n,o){if(null==n||"object"!=typeof n)throw new TypeError("changes parameter should be an object");null==o&&(o={});const i=null!=o.id?o.id:n.id;if(null==i)throw new TypeError("missing entity id");null!=n.id&&delete n.id;const s=t.get(this),a=new r(l(e.endpoints.ld.TEMPORAL_ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(i)}),s.url);return p.call(s,a,{method:"POST",postBody:n,requestHeaders:{"NGSILD-Tenant":o.tenant}}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.deleteTemporalEntityAttribute=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");const o=t.get(this),i=new r(l(e.endpoints.ld.TEMPORAL_ENTITY_ATTRS_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute)}),o.url),s={datasetId:n.datasetId,deleteAll:n.deleteAll},a={"NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(a.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"DELETE",parameters:s,requestHeaders:a}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.updateTemporalEntityAttributeInstance=function(n,o){if(null==n||"object"!=typeof n)throw new TypeError("changes parameter should be an object");null==o&&(o={});const i=o.id;if(null==i)throw new TypeError("missing entity id");const s=o.attribute;if(null==s)throw new TypeError("missing entity attribute to update");const a=o.instance;if(null==a)throw new TypeError("missing attribute instance id");const c=t.get(this),u=new r(l(e.endpoints.ld.TEMPORAL_ENTITY_ATTRS_INSTANCE_ENTRY,{entityId:encodeURIComponent(i),attribute:encodeURIComponent(s),instanceId:encodeURIComponent(a)}),c.url),d={"NGSILD-Tenant":o.tenant};return"string"==typeof o["@context"]&&(d.Link="<"+encodeURI(o["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(c,u,{method:"PATCH",postBody:n,requestHeaders:d}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},e.Connection.LD.prototype.deleteTemporalEntityAttributeInstance=function(n){if(null==n)throw new TypeError("missing options parameter");if(null==n.id)throw new TypeError("missing id option");if(null==n.attribute)throw new TypeError("missing attribute option");if(null==n.instance)throw new TypeError("missing instance option");const o=t.get(this),i=new r(l(e.endpoints.ld.TEMPORAL_ENTITY_ATTRS_INSTANCE_ENTRY,{entityId:encodeURIComponent(n.id),attribute:encodeURIComponent(n.attribute),instanceId:encodeURIComponent(n.instance)}),o.url),s={"NGSILD-Tenant":n.tenant};return"string"==typeof n["@context"]&&(s.Link="<"+encodeURI(n["@context"])+'>; rel="http://www.w3.org/ns/json-ld#context"; type="application/ld+json"'),p.call(o,i,{method:"DELETE",requestHeaders:s}).then(t=>400===t.status?G(t):404===t.status?V(t):204!==t.status?Promise.reject(new e.InvalidResponseError("Unexpected error code: "+t.status)):Promise.resolve({}))},"undefined"!=typeof window&&(window.NGSI=e)}();