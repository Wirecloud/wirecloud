!function(){"use strict";var a,b=new WeakMap;if("function"==typeof require&&null!=typeof exports){a=exports;var c=require("whatwg-url").URL}else{a={};var c=window.URL,d=function(a){return Array.prototype.slice.call(arguments,1).forEach(function(b){null!=b&&Object.keys(b).forEach(function(c){a[c]=b[c]})}),a},e=function(){var a,b;a=d({Accept:"application/json, */*"},this.options.requestHeaders),null==this.options.postBody||"Content-Type"in a||null==this.options.contentType||(a["Content-Type"]=this.options.contentType,null!=this.options.encoding&&(a["Content-Type"]+="; charset="+this.options.encoding));for(b in a)null!=a[b]&&this.transport.setRequestHeader(b,a[b])},f=function(a){Object.defineProperties(this,{request:{value:a},transport:{value:a.transport},status:{value:a.transport.status},statusText:{value:a.transport.statusText},response:{value:a.transport.response}}),null!=a.options.responseType&&""!==a.options.responseType||Object.defineProperties(this,{responseText:{value:a.transport.responseText},responseXML:{value:a.transport.responseXML}})};f.prototype.getHeader=function(a){try{return this.transport.getResponseHeader(a)}catch(a){return null}};var g=function(a){var b,c=[];if(null==a||"object"!=typeof a)return null;for(b in a)void 0!==a[b]&&(null===a[b]?c.push(encodeURIComponent(b)+"="):c.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b])));return c.length>0?c.join("&"):null},h=function(b,c){this.options=d({method:"POST",asynchronous:!0,responseType:null,contentType:null,encoding:null,postBody:null},c),Object.defineProperties(this,{method:{value:this.options.method.toUpperCase()}});var h=g(this.options.parameters);-1!==["PUT","POST"].indexOf(this.method)&&null==this.options.postBody?null!=h&&(this.options.postBody=h,null==this.options.contentType&&(this.options.contentType="application/x-www-form-urlencoded"),null==this.options.encoding&&(this.options.encoding="UTF-8")):null!=h&&(""!==b.search?b.search=b.search+"&"+h:b.search="?"+h),Object.defineProperties(this,{url:{value:b},abort:{value:function(){return this.transport.aborted=!0,this.transport.abort(),this}}}),Object.defineProperty(this,"transport",{value:new XMLHttpRequest}),!0===this.options.withCredentials&&this.options.supportsAccessControl&&(this.transport.withCredentials=!0),this.options.responseType&&(this.transport.responseType=this.options.responseType),this.promise=new Promise(function(b,c){this.transport.addEventListener("abort",function(a){a.stopPropagation(),a.preventDefault(),c("aborted")}),this.transport.addEventListener("load",function(){var a=new f(this);b(a)}.bind(this)),this.transport.addEventListener("error",function(){c(new a.ConnectionError(this))}.bind(this))}.bind(this)),this.transport.open(this.method,this.url,this.options.asynchronous),e.call(this),this.transport.send(this.options.postBody)};h.prototype.then=function(a,b){return this.promise.then(a,b)},h.prototype.catch=function(a){return this.promise.catch(a)};var i=function(a,b){return new h(a,b)}}a.endpoints={SERVER_DETAILS:"version",v1:{REGISTER_CONTEXT:"v1/registry/registerContext",DISCOVER_CONTEXT_AVAILABILITY:"v1/registry/discoverContextAvailability",SUBSCRIBE_CONTEXT_AVAILABILITY:"v1/registry/subscribeContextAvailability",UPDATE_CONTEXT_AVAILABILITY_SUBSCRIPTION:"v1/registry/updateContextAvailabilitySubscription",UNSUBSCRIBE_CONTEXT_AVAILABILITY:"v1/registry/unsubscribeContextAvailability",QUERY_CONTEXT:"v1/queryContext",UPDATE_CONTEXT:"v1/updateContext",SUBSCRIBE_CONTEXT:"v1/subscribeContext",UPDATE_CONTEXT_SUBSCRIPTION:"v1/updateContextSubscription",UNSUBSCRIBE_CONTEXT:"v1/unsubscribeContext",CONTEXT_TYPES:"v1/contextTypes"},v2:{BATCH_QUERY_OP:"v2/op/query",BATCH_UPDATE_OP:"v2/op/update",ENTITY_ATTRS_COLLECTION:"v2/entities/%(entityId)s/attrs",ENTITY_ATTR_ENTRY:"v2/entities/%(entityId)s/attrs/%(attribute)s",ENTITY_ATTR_VALUE_ENTRY:"v2/entities/%(entityId)s/attrs/%(attribute)s/value",ENTITY_COLLECTION:"v2/entities",ENTITY_ENTRY:"v2/entities/%(entityId)s",SUBSCRIPTION_COLLECTION:"v2/subscriptions",SUBSCRIPTION_ENTRY:"v2/subscriptions/%(subscriptionId)s",TYPE_COLLECTION:"v2/types",TYPE_ENTRY:"v2/types/%(typeId)s"}},a.proxy_endpoints={EVENTSOURCE_COLLECTION:"eventsource",CALLBACK_COLLECTION:"callbacks"};var j=function(a,b){return a.replace(/%\(\w+\)s/g,function(a){return String(b[a.slice(2,-2)])})},k=function(b,c,d,e,f){var g,h=null,i=null;null!=c&&(i="application/json",h=JSON.stringify(c)),g=JSON.parse(JSON.stringify(this.headers)),g.Accept="application/json",this.makeRequest(b,{method:null!=h?"POST":"GET",contentType:i,requestHeaders:g,parameters:f,postBody:h}).then(function(b){var c;if(200!==b.status)"function"==typeof e.onFailure&&(c=b instanceof a.ConnectionError?b:-1!==[0,502,504].indexOf(b.status)?new a.ConnectionError("Connection Error"):new a.InvalidResponseError("Unexpected error code: "+b.status),e.onFailure(c));else if("function"==typeof e.onSuccess){var f;try{try{f=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content")}f=d(f,e)}catch(a){return"function"==typeof e.onFailure&&e.onFailure(a),void("function"==typeof e.onComplete&&e.onComplete())}e.onSuccess.apply(null,f)}"function"==typeof e.onComplete&&e.onComplete()},function(b){if("function"==typeof e.onFailure){b instanceof a.ConnectionError||(b=new a.ConnectionError);try{e.onFailure(b)}catch(a){}}"function"==typeof e.onComplete&&e.onComplete()})},l=function(a,b){var c=a.trim().toLowerCase(),d=Object.keys(b),e=d.map(function(a){return a.trim().toLowerCase()}).indexOf(c);-1!==e&&delete b[d[e]]},m=function(b,c){null!=c.postBody&&(c.contentType="application/json",c.postBody=JSON.stringify(c.postBody));var d=JSON.parse(JSON.stringify(this.headers));d.Accept="application/json";for(var e in c.requestHeaders)null!=c.requestHeaders[e]&&(l(e,d),d[e]=c.requestHeaders[e]);return c.requestHeaders=d,this.makeRequest(b,c).then(function(b){return-1!==[0,502,504].indexOf(b.status)?Promise.reject(new a.ConnectionError):Promise.resolve(b)},function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})},n=function(a){var b,c;return c="string"==typeof a.isPattern&&"true"===a.isPattern.trim().toLowerCase()||!0===a.isPattern,b={id:""+a.id,isPattern:""+c},null!=a.type&&(b.type=""+a.type),b},o=function(a){var b,c,d;if("polygon"in a.value){for(b={polygon:{vertices:[]}},c=0;c<a.value.polygon.vertices.length;c++)d=a.value.polygon.vertices[c],b.polygon.vertices.push({latitude:""+d.latitude,longitude:""+d.longitude});a.value.polygon.inverted&&(b.polygon.inverted="true")}else"circle"in a.value&&(b={circle:{centerLatitude:""+a.value.circle.centerLatitude,centerLongitude:""+a.value.circle.centerLongitude,radius:a.value.circle.radius}},a.value.circle.inverted&&(b.circle.inverted="true"));return b},p=function(a){var b,c;if(b={scopes:[]},Array.isArray(a.scopes))for(c=0;c<a.scopes.length;c++)b.scopes.push({type:a.scopes[c].type,value:o(a.scopes[c])});return b},q=function(a){var b,c;for(b=[],c=0;c<a.length;c++)b.push({name:""+a[c].name,type:""+a[c].type,value:""+a[c].value});return b},r=function(a,b,c,d,e){var f,g,h,i;for(f={contextRegistrations:[{entities:[],attributes:[],providingApplication:d}],duration:""+c},g=0;g<a.length;g+=1)f.contextRegistrations[0].entities.push(n(a[g]));for(g=0;g<b.length;g+=1)h=b[g],i={name:h.name,isDomain:"false"},null!=h.type&&(i.type=""+h.type),f.contextRegistrations[0].attributes.push(i);return null!=e&&(f.registrationId=""+e),f},s=function(a,b,c){var d,e;for(d={entities:[]},e=0;e<a.length;e+=1)d.entities.push(n(a[e]));if(Array.isArray(b)&&b.length>0)for(d.attributes=[],e=0;e<b.length;e+=1)d.attributes.push(""+b[e]);return null!=c&&(d.restriction=p(c)),d},t=function(a,b){var c,d,e,f,g,h,i,j,k;for(c={contextElements:[],updateAction:a},d=0;d<b.length;d+=1){if(f=n(b[d].entity),null!=(h=b[d].attributes))for(g=f.attributes=[],e=0;e<h.length;e+=1)i=h[e],j={name:""+i.name},null!=i.type&&(j.type=""+i.type),"DELETE"!==a&&(k=null!=i.value?i.value:null!=i.contextValue?i.contextValue:null,j.value=k),Array.isArray(i.metadata)&&i.metadata.length>0&&(j.metadatas=q(i.metadata)),g.push(j);c.contextElements.push(f)}return c},u=function(a,b){var c,d;for(c={entities:[],attributes:b},d=0;d<a.length;d+=1)c.entities.push(n(a[d]));return c},v=function(a,b,c,d,e,f){var g,h;for(g=e?{entities:[],subscriptionId:e}:{entities:[],reference:f},h=0;h<a.length;h+=1)g.entities.push(n(a[h]));return Array.isArray(b)&&b.length>0&&(g.attributes=b),null!=c&&(g.duration=""+c),null!=d&&(g.restriction=p(d)),g},w=function(a){return{subscriptionId:a}},x=function(a,b,c,d,e,f,g){var h,i,j,k;if(a)h={subscriptionId:a};else{for(h={entities:[],reference:g},i=0;i<b.length;i+=1)h.entities.push(n(b[i]));Array.isArray(c)&&(h.attributes=c)}if(null!=d&&(h.duration=""+d),Array.isArray(f))for(h.notifyConditions=[],i=0;i<f.length;i+=1)j=f[i],k={type:j.type},h.notifyConditions.push(k),Array.isArray(j.condValues)&&(k.condValues=j.condValues);return null!=e&&(h.throttling=""+e),h},y=function(a){return{subscriptionId:a}},z=function(a,b,c){return null!=a.type&&(c.type=a.type,delete a.type),!0===b.keyValues&&(c.options="keyValues"),delete a.id,a},A=function(b){if(J(b),"object"!=typeof b||"string"!=typeof b.registrationId||"string"!=typeof b.duration)throw new a.InvalidResponseError("The server returned an invalid json structure");return[b]},B=function(a){var b,c,d,e=[];for(d=0;d<a.length;d+=1)b=a[d].contextRegistration,c={entities:[],attributes:[],providingApplication:b.providingApplication},null!=b.entities&&(c.entities=b.entities),null!=b.attributes&&(c.attributes=b.attributes),e.push(c);return e},C=function(b){if("object"!=typeof b||Array.isArray(b))throw new a.InvalidResponseError("The server returned an invalid json structure");if(J(b),!Array.isArray(b.contextRegistrationResponses))throw new a.InvalidResponseError("The server returned an invalid json structure");return[B(b.contextRegistrationResponses)]},D=function(b){if(J(b),"string"!=typeof b.subscriptionId)throw new a.InvalidResponseError("The server returned an invalid json structure");if("duration"in b&&"string"!=typeof b.duration)throw new a.InvalidResponseError("The server returned an invalid json structure");return[b]},E=function(b){if("object"!=typeof b||Array.isArray(b)||!("subscriptionId"in b))throw new a.InvalidResponseError("The server returned an invalid json structure");return[{subscriptionId:b.subscriptionId,statusCode:I(b)}]},F=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n;for(f=!!c.flat,j=f?{}:[],n=[],b&&(i=""),g=0;g<a.length;g+=1){if(d=a[g].contextElement,m=I(a[g]),e=f?{}:{entity:null,attributes:[]},200===m.code&&f?(e.id=d.id,e.type=d.type):e.entity={id:d.id,type:d.type},null!=d.attributes)for(h=0;h<d.attributes.length;h+=1)k=d.attributes[h],b||(i=k.value),f?e[k.name]=i:(l={name:k.name,type:k.type},b||(l.value=i),null!=k.metadatas&&(l.metadata=k.metadatas),e.attributes.push(l));200===m.code?f?j[d.id]=e:j.push(e):(b&&(e.statusCode=m),n.push(e))}return[j,n]},G=function(b,c){var d,e,f;if(e=I(b),404===e.code){if("string"==typeof e.details&&(d=e.details.match(L))&&(f=e.details={text:e.details,matches:parseInt(d[1]),offset:parseInt(d[2])}),c.details&&(f={count:0}),0!==c.offset)throw e;return[[],f]}if(200!==e.code)throw new a.InvalidResponseError("Unexpected error code");return"string"==typeof e.details&&(d=e.details.match(K))&&(f={count:parseInt(d[1],10)}),[b.types,f]},H=function(b){var c;if("object"!=typeof b||Array.isArray(b))throw new a.InvalidResponseError("The server returned an invalid json structure");if(c=I(b),404===c.code)throw new a.NotFoundError({details:b,message:c.reasonPhrase});if(200!==c.code)throw new a.InvalidResponseError("Unexpected error code");return delete b.statusCode,[b]},I=function(b){if(!("statusCode"in b))throw new a.InvalidResponseError("missing response status code info");return b.statusCode.code=parseInt(b.statusCode.code,10),b.statusCode},J=function(b){if("errorCode"in b)throw new a.InvalidRequestError(parseInt(b.errorCode.code,10),b.errorCode.reasonPhrase,b.errorCode.details)},K=new RegExp("Count: (\\d+)"),L=new RegExp("Number of matching entities: (\\d+). Offset is (\\d+)"),M=function(b,c){var d,e,f;if("object"!=typeof b||Array.isArray(b))throw new a.InvalidResponseError("The server returned an invalid json structure");try{J(b)}catch(a){switch(a.code){case 200:e=a.details.match(K),e&&(d={count:parseInt(e[1],10)});break;case 404:if(f=c.flat?{}:[],e=a.details.match(L),e?d=a.details={text:a.details,matches:parseInt(e[1]),offset:parseInt(e[2])}:!0===c.details&&0===c.offset&&(d=a.details={count:0}),0!==c.offset)throw a;return[f,d];default:throw a}}if(!Array.isArray(b.contextResponses))throw new a.InvalidResponseError("The server returned an invalid json structure");return[F(b.contextResponses,!1,c)[0],d]},N=function(a,b){return J(a),F(a.contextResponses,!0,b)},O=function(b){if(J(b),"string"!=typeof b.subscriptionId)throw new a.InvalidResponseError("The server returned an invalid json structure");if("duration"in b&&"string"!=typeof b.duration)throw new a.InvalidResponseError("The server returned an invalid json structure");if("throttling"in b&&"string"!=typeof b.throttling)throw new a.InvalidResponseError("The server returned an invalid json structure");return b},P=function(b){if(J(b),"object"!=typeof b||"object"!=typeof b.subscribeResponse)throw new a.InvalidResponseError("The server returned an invalid json structure");return[O(b.subscribeResponse)]},Q=function(b){if(J(b),"object"!=typeof b||"object"!=typeof b.subscribeResponse)throw new a.InvalidResponseError("The server returned an invalid json structure");return[O(b.subscribeResponse)]},R=function(b){if(J(b),"object"!=typeof b||"string"!=typeof b.subscriptionId)throw new a.InvalidResponseError("The server returned an invalid json structure");return b.statusCode=I(b),[b]},S=function(b,c){if("object"!=typeof b||Array.isArray(b)||!Array.isArray(b.contextRegistrationResponses))throw new a.InvalidResponseError("The server returned an invalid json structure");return[B(b.contextRegistrationResponses)]},T=function(a,b){var c={};if(null!=a.limit){if("number"!=typeof a.limit||a.limit<20)throw new TypeError("invalid value for the limit option");c.limit=a.limit}if(null!=a.offset){if("number"!=typeof a.offset||a.offset<0)throw new TypeError("invalid value for the offset option");c.offset=a.offset}else a.offset=0;if(null!=b)if(null!=a.details){if("boolean"!=typeof a.details)throw new TypeError("invalid value for the details option");a.details?c.details="on":c.details="off"}else c.details=b,a.details="on"===b;return c},U=function(a,b){var c={};if(null!=a.limit){if("number"!=typeof a.limit||!Number.isInteger(a.limit)||a.limit<1)throw new TypeError("invalid value for the limit option");c.limit=a.limit}else a.limit=20;if(null!=a.offset){if("number"!=typeof a.offset||!Number.isInteger(a.offset)||a.offset<0)throw new TypeError("invalid value for the offset option");c.offset=a.offset}else a.offset=0;if(null!=a.count){if("boolean"!=typeof a.count)throw new TypeError("invalid value for the count option");b.push("count")}return c},V=function(a){if("application/json"!==a.getHeader("Content-Type"))throw new TypeError("Unexpected response mimetype");return JSON.parse(a.responseText)},W=function(b,c){try{var d=V(b)}catch(b){return Promise.reject(new a.InvalidResponseError(null,c))}return Promise.reject(new a.BadRequestError({message:d.description,correlator:c}))},X=function(b,c){try{var d=V(b)}catch(b){return Promise.reject(new a.InvalidResponseError(null,c))}return Promise.reject(new a.NotFoundError({message:d.description,correlator:c}))},Y=function(b,c){try{var d=V(b)}catch(b){return Promise.reject(new a.InvalidResponseError(null,c))}return Promise.reject(new a.TooManyResultsError({message:d.description,correlator:c}))};a.parseNotifyContextRequest=function(a,b){return{elements:F(a.contextResponses,!1,b)[0],subscriptionId:a.subscriptionId,originator:a.originator}};var Z=function(){return this.makeRequest(new c(a.proxy_endpoints.EVENTSOURCE_COLLECTION,this.url),{supportsAccessControl:!0,method:"POST"}).then(function(d){if(-1!==[0,502,504].indexOf(d.status))return b.get(this).promise=null,Promise.reject(new a.ConnectionError);if(201!==d.status)return b.get(this).promise=null,Promise.reject(new a.InvalidResponseError("Unexpected error code: "+d.status));var e=b.get(this);try{e.source_url=new c(d.getHeader("Location"))}catch(c){return b.get(this).promise=null,Promise.reject(new a.InvalidResponseError("Invalid/missing Location Header"))}return $.call(this)}.bind(this),function(c){return b.get(this).promise=null,c instanceof a.ConnectionError||(c=new a.ConnectionError),Promise.reject(c)}.bind(this))},$=function(){var c=b.get(this);return new Promise(function(b,d){var e,f=function a(d){var f=JSON.parse(d.data);clearTimeout(e),c.promise=null,c.connection_id=f.id,c.source.removeEventListener("error",h,!0),c.source.removeEventListener("init",a,!0),c.source.addEventListener("error",function(a){c.connected=!1,c.source=null,c.connection_id=null;var b=c.callbacks;c.callbacks={},c.callbacksBySubscriptionId={};for(var d in b)b[d].method(null,null,!0)},!0),c.source.addEventListener("notification",function(a){var b=JSON.parse(a.data);c.callbacks[b.callback_id].method(b.payload,b.headers)},!0),b()},g=function(b){c.promise=null,c.source.close(),c.source=null,d(new a.ConnectionError(b))},h=g.bind(null,"Connection rejected"),i=g.bind(null,"Connection timeout");c.source=new EventSource(c.source_url),c.source.addEventListener("error",h,!0),c.source.addEventListener("init",f,!0),e=setTimeout(i,3e4)})},_=function(){var a={},c=b.get(this).callbacks;for(var d in c)a[d]=null!=c[d].subscription?c[d].subscription.id:null;return a},aa=function(){var a={},c=b.get(this).callbacks;for(var d in c)a[d]=c[d].subscription;return a},ba=function(){var a=b.get(this);return null!=a.source&&null!=a.connection_id},ca=function(){return null!==b.get(this).promise},da=function(){return b.get(this).connection_id},ea=function(){var a={},c=b.get(this).callbacksBySubscriptionId;for(var d in c)a[d]=c[d].callback_id;return a};a.ProxyConnection=function(a,d){try{a=new c(a)}catch(a){throw new TypeError("invalid url parameter")}if("http:"!==a.protocol&&"https:"!==a.protocol)throw new TypeError("unsupported protocol: "+a.protocol.substr(0,a.protocol.length-1));"/"!==a.pathname[a.pathname.length-1]&&(a.pathname+="/"),this.makeRequest=d,b.set(this,{callbacks:{},callbacksBySubscriptionId:{},connected:!1,connection_id:null,promise:null,source:null}),Object.defineProperties(this,{callbackSubscriptions:{get:_},callbackSubscriptionsVersioned:{get:aa},connected:{get:ba},connecting:{get:ca},connection_id:{get:da},subscriptionCallbacks:{get:ea},url:{value:a}})},a.ProxyConnection.prototype.connect=function(){if(!0===this.connected)return Promise.resolve();var a=b.get(this);return null===a.promise&&(a.promise=Z.call(this)),a.promise},a.ProxyConnection.prototype.requestCallback=function(d){if("function"!=typeof d)throw new TypeError("callback parameter must be a function");return this.connect().then(function(){return this.makeRequest(new c(a.proxy_endpoints.CALLBACK_COLLECTION,this.url),{supportsAccessControl:!0,method:"POST",contentType:"application/json",postBody:JSON.stringify({connection_id:this.connection_id})}).then(function(c){if(-1===[200,201].indexOf(c.status))return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+c.status));var e=JSON.parse(c.responseText);return b.get(this).callbacks[e.callback_id]={callback_id:e.callback_id,method:d,subscription:null},Promise.resolve(e)}.bind(this),function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})}.bind(this))},a.ProxyConnection.prototype.close=function(c){if(!1===this.connected)return Promise.resolve();!1!==c&&(c=!0);var d=b.get(this);return this.makeRequest(d.source_url,{supportsAccessControl:!0,method:"DELETE",asynchronous:c}).then(function(b){if(204!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status));d.source.close(),d.source=null,d.connection_id=null,d.callbacks={},d.callbacksBySubscriptionId={}}.bind(this),function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})},a.ProxyConnection.prototype.closeCallback=function(b){return this.makeRequest(new c(a.proxy_endpoints.CALLBACK_COLLECTION+"/"+b,this.url),{supportsAccessControl:!0,method:"DELETE"}).then(function(c){if(204!==c.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+c.status));this.purgeCallback(b)}.bind(this),function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})},a.ProxyConnection.prototype.associateSubscriptionId=function(a,c,d){var e=b.get(this);if(!(a in e.callbacks))return this;if(null!=e.callbacks[a].subscription)throw new TypeError("Already associated callback");return e.callbacksBySubscriptionId[c]=e.callbacks[a],e.callbacks[a].subscription={id:c,version:d},this},a.ProxyConnection.prototype.closeSubscriptionCallback=function(a){var c=b.get(this);return a in c.callbacksBySubscriptionId?this.closeCallback(c.callbacksBySubscriptionId[a].callback_id):Promise.resolve()},a.ProxyConnection.prototype.purgeCallback=function(a){var c=b.get(this);if(a in c.callbacks){var d=c.callbacks[a].subscription;null!=d&&delete c.callbacksBySubscriptionId[d.id],delete c.callbacks[a]}},a.ConnectionError=function(a){this.name="ConnectionError",this.message=a||"Connection Error"},a.ConnectionError.prototype=new Error,a.ConnectionError.prototype.constructor=a.ConnectionError,a.InvalidRequestError=function(a,b,c){this.name="InvalidRequest",this.code=a,this.message=b||"",this.details=c||""},a.InvalidRequestError.prototype=new Error,a.InvalidRequestError.prototype.constructor=a.InvalidRequestError,a.AlreadyExistsError=function(a){this.name="AlreadyExists",this.message=a.message||"",this.correlator=a.correlator||null},a.AlreadyExistsError.prototype=new Error,a.AlreadyExistsError.prototype.constructor=a.AlreadyExistsError,a.BadRequestError=function(a){this.name="BadRequest",this.message=a.message||"",this.correlator=a.correlator||null},a.BadRequestError.prototype=new Error,a.BadRequestError.prototype.constructor=a.BadRequestError,a.InvalidResponseError=function(a,b){this.name="InvalidResponse",this.message=a||"",this.correlator=b},a.InvalidResponseError.prototype=new Error,a.InvalidResponseError.prototype.constructor=a.InvalidResponseError,a.NotFoundError=function(a){this.name="NotFound",this.message=a.message||"",this.details=a.details||"",this.correlator=a.correlator||null},a.NotFoundError.prototype=new Error,a.NotFoundError.prototype.constructor=a.NotFoundError,a.TooManyResultsError=function(a){this.name="TooManyResults",this.message=a.message||"",this.correlator=a.correlator||null},a.TooManyResultsError.prototype=new Error,a.TooManyResultsError.prototype.constructor=a.TooManyResultsError,a.ProxyConnectionError=function(a){this.name="ProxyConnectionError",this.cause=a},a.ProxyConnectionError.prototype=new Error,a.ProxyConnectionError.prototype.constructor=a.ProxyConnectionError,a.Connection=function(b,d){try{b=new c(b)}catch(a){throw new TypeError("invalid url parameter")}if("http:"!==b.protocol&&"https:"!==b.protocol)throw new TypeError("unsupported protocol: "+b.protocol.substr(0,b.protocol.length-1));"/"!==b.pathname[b.pathname.length-1]&&(b.pathname+="/"),null==d&&(d={}),null!=d.headers&&"object"==typeof d.headers?this.headers=d.headers:null!=d.request_headers?this.headers=d.request_headers:this.headers={},null!=d.service&&(l("FIWARE-Service",this.headers),this.headers["FIWARE-Service"]=d.service),null!=d.servicepath&&(l("FIWARE-ServicePath",this.headers),this.headers["FIWARE-ServicePath"]=d.servicepath),"function"==typeof d.requestFunction?this.makeRequest=d.requestFunction:this.makeRequest=i,d.ngsi_proxy_connection instanceof a.ProxyConnection?this.ngsi_proxy=d.ngsi_proxy_connection:"string"==typeof d.ngsi_proxy_url&&(this.ngsi_proxy=new a.ProxyConnection(d.ngsi_proxy_url,this.makeRequest)),Object.defineProperties(this,{url:{value:b},v1:{value:this},v2:{value:new a.Connection.V2(this)}})},a.Connection.prototype.getServerDetails=function(b){null==b&&(b={});var d=new c(a.endpoints.SERVER_DETAILS,this.url);return m.call(this,d,{method:"GET",requestHeaders:{"FIWARE-Correlator":b.correlator}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){return Promise.reject(new a.InvalidResponseError("Server returned invalid JSON content",c))}var e={details:d,correlator:c};return Promise.resolve(e)})},a.Connection.prototype.createRegistration=function(b,d,e,f,g){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributes parameter must be an array or null");null==d&&(d=[]),null==g&&(g={});var h=r(b,d,e,f),i=new c(a.endpoints.v1.REGISTER_CONTEXT,this.url);k.call(this,i,h,A,g)},a.Connection.prototype.updateRegistration=function(b,d,e,f,g,h){if(!Array.isArray(d)||0===d.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=e&&!Array.isArray(e))throw new TypeError("attributes parameter must be an array or null");null==e&&(e=[]),null==h&&(h={});var i=r(d,e,f,g,b),j=new c(a.endpoints.v1.REGISTER_CONTEXT,this.url);return k.call(this,j,i,A,h)},a.Connection.prototype.cancelRegistration=function(a,b){if(null==a)throw new TypeError("regId parameter cannot be null");this.updateRegistration(a,[{id:"canceled registration"}],[],"PT0H","http://canceled.registration.com",b)},a.Connection.prototype.discoverAvailability=function(b,d,e){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributeNames parameter must be an array or null");null==d&&(d=[]),null==e&&(e={});var f=u(b,d),g=new c(a.endpoints.v1.DISCOVER_CONTEXT_AVAILABILITY,this.url);k.call(this,g,f,C,e)},a.Connection.prototype.createAvailabilitySubscription=function(b,d,e,f,g){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributeNames parameter must be an array or null");if(null==g)throw new TypeError("Missing options parameter");if("string"!=typeof g.onNotify&&"function"!=typeof g.onNotify)throw new TypeError("Invalid onNotify callback");if("function"==typeof g.onNotify&&null==this.ngsi_proxy)throw new TypeError("A ngsi-proxy is needed for using local onNotify callbacks");var h=new c(a.endpoints.v1.SUBSCRIBE_CONTEXT_AVAILABILITY,this.url);if("function"==typeof g.onNotify&&null!=this.ngsi_proxy){var i=function(a){var b=JSON.parse(a),c=S(b);g.onNotify(c)};this.ngsi_proxy.requestCallback(i).then(function(a){var c=v(b,d,e,f,null,a.url),i=g.onFailure;g.onFailure=function(){this.ngsi_proxy.closeCallback(a.callback_id),"function"==typeof i&&i.apply(this,arguments)}.bind(this);var j=g.onSuccess;g.onSuccess=function(b){this.ngsi_proxy.associateSubscriptionId(a.callback_id,b.subscriptionId,"v1-availability"),"function"==typeof j&&j(b)}.bind(this),k.call(this,h,c,D,g)}.bind(this),function(){"function"==typeof g.onFailure&&g.onFailure()})}else{var j=v(b,d,e,f,null,g.onNotify);k.call(this,h,j,D,g)}},a.Connection.prototype.updateAvailabilitySubscription=function(b,d,e,f,g,h){if(null==b)throw new TypeError("subId parameter cannot be null");if(!Array.isArray(d)||0===d.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=e&&!Array.isArray(e))throw new TypeError("attributeNames parameter must be an array or null");null==h&&(h={});var i=v(d,e,f,g,b),j=new c(a.endpoints.v1.UPDATE_CONTEXT_AVAILABILITY_SUBSCRIPTION,this.url);k.call(this,j,i,D,h)},a.Connection.prototype.cancelAvailabilitySubscription=function(b,d){if(null==b)throw new TypeError("subId parameter cannot be null");null==d&&(d={});var e=w(b),f=new c(a.endpoints.v1.UNSUBSCRIBE_CONTEXT_AVAILABILITY,this.url);k.call(this,f,e,E,d)},a.Connection.prototype.query=function(b,d,e){var f,g,h;if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributesName must be null or an array");null==d&&(d=[]),null==e&&(e={}),g=T(e,"off"),f=new c(a.endpoints.v1.QUERY_CONTEXT,this.url),h=s(b,d,e.restriction),k.call(this,f,h,M,e,g)},a.Connection.prototype.updateAttributes=function(b,d){if(!Array.isArray(b)||0===b.length)throw new TypeError("update parameter must be a non-empty array");null==d&&(d={});var e=t("UPDATE",b),f=new c(a.endpoints.v1.UPDATE_CONTEXT,this.url);k.call(this,f,e,N,d)},a.Connection.prototype.addAttributes=function(b,d){if(!Array.isArray(b)||0===b.length)throw new TypeError("toAdd parameter must be a non-empty array");null==d&&(d={});var e=t("APPEND",b),f=new c(a.endpoints.v1.UPDATE_CONTEXT,this.url);k.call(this,f,e,N,d)},a.Connection.prototype.deleteAttributes=function(b,d){if(!Array.isArray(b)||0===b.length)throw new TypeError("toDelete parameter must be a non-empty array");null==d&&(d={});var e=t("DELETE",b),f=new c(a.endpoints.v1.UPDATE_CONTEXT,this.url);k.call(this,f,e,N,d)},a.Connection.prototype.createSubscription=function(b,d,e,f,g,h){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributeNames parameter must be an array or null");if(null==h)throw new TypeError("Missing options parameter");if("string"!=typeof h.onNotify&&"function"!=typeof h.onNotify)throw new TypeError("Invalid onNotify callback");if("function"==typeof h.onNotify&&null==this.ngsi_proxy)throw new TypeError("A ngsi-proxy is needed for using local onNotify callbacks");var i=new c(a.endpoints.v1.SUBSCRIBE_CONTEXT,this.url);if("function"==typeof h.onNotify&&null!=this.ngsi_proxy){var j=function(b){var c=JSON.parse(b),d=a.parseNotifyContextRequest(c,h);h.onNotify(d)};this.ngsi_proxy.requestCallback(j).then(function(a){var c=x(null,b,d,e,f,g,a.url),j=h.onFailure;h.onFailure=function(){this.ngsi_proxy.closeCallback(a.callback_id).catch(function(a){console.log("Error closing callback on the ngsi-proxy")}),"function"==typeof j&&j.apply(this,arguments)}.bind(this);var l=h.onSuccess;h.onSuccess=function(b){this.ngsi_proxy.associateSubscriptionId(a.callback_id,b.subscriptionId,"v1"),"function"==typeof l&&l(b)}.bind(this),k.call(this,i,c,P,h)}.bind(this),function(b){if("function"==typeof h.onFailure){var c=new a.ProxyConnectionError(b);try{h.onFailure(c)}catch(a){}}if("function"==typeof h.onComplete)try{h.onComplete()}catch(a){}})}else{var l=x(null,b,d,e,f,g,h.onNotify);k.call(this,i,l,P,h)}},a.Connection.prototype.updateSubscription=function(b,d,e,f,g){if(null==b)throw new TypeError("subId parameter cannot be null");null==g&&(g={});var h=x(b,null,null,d,e,f),i=new c(a.endpoints.v1.UPDATE_CONTEXT_SUBSCRIPTION,this.url);k.call(this,i,h,Q,g)},a.Connection.prototype.cancelSubscription=function(b,d){if(null==b)throw new TypeError("subId parameter cannot be null");if(null==d&&(d={}),this.ngsi_proxy){var e=d.onSuccess;d.onSuccess=function(a){this.ngsi_proxy.closeSubscriptionCallback(a.subscriptionId),"function"==typeof e&&e(a)}.bind(this)}var f=y(b),g=new c(a.endpoints.v1.UNSUBSCRIBE_CONTEXT,this.url);k.call(this,g,f,R,d)},a.Connection.prototype.getAvailableTypes=function(b){var d=new c(a.endpoints.v1.CONTEXT_TYPES,this.url),e=T(b,"on");k.call(this,d,null,G,b,e)},a.Connection.prototype.getTypeInfo=function(b,d){if(null==b)throw new TypeError("Invalid type parameter");var e=new c(a.endpoints.v1.CONTEXT_TYPES+"/"+encodeURIComponent(b),this.url);k.call(this,e,null,H,d)},a.Connection.V2=function(a){b.set(this,a)},a.Connection.V2.prototype.listEntities=function(d){if(null==d&&(d={}),
null!=d.id&&null!=d.idPattern)throw new TypeError("id and idPattern options cannot be used at the same time");if(null!=d.type&&null!=d.typePattern)throw new TypeError("type and typePattern options cannot be used at the same time");var e=b.get(this),f=new c(a.endpoints.v2.ENTITY_COLLECTION,e.url),g=[],h=U(d,g);return!0===d.keyValues&&g.push("keyValues"),!0===d.values&&g.push("values"),!0===d.unique&&g.push("unique"),0!==g.length&&(h.options=g.join(",")),h.attrs=d.attrs,h.id=d.id,h.idPattern=d.idPattern,h.orderBy=d.orderBy,h.metadata=d.metadata,h.mq=d.mq,h.q=d.q,h.type=d.type,h.typePattern=d.typePattern,h.georel=d.georel,h.geometry=d.geometry,h.coords=d.coords,m.call(e,f,{method:"GET",parameters:h,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var e=JSON.parse(b.responseText)}catch(b){return Promise.reject(new a.InvalidResponseError("Server returned invalid JSON content",c))}var f={results:e,limit:d.limit,offset:d.offset,correlator:c};return!0===d.count&&(f.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(f)})},a.Connection.V2.prototype.createEntity=function(d,e){if(null==e&&(e={}),null==d.id)throw new TypeError("missing entity id");var f=b.get(this),g={};!0===e.keyValues&&!0===e.upsert?g.options="keyValues,upsert":!0===e.upsert?g.options="upsert":!0===e.keyValues&&(g.options="keyValues");var h=new c(a.endpoints.v2.ENTITY_COLLECTION,f.url);return m.call(f,h,{method:"POST",postBody:d,parameters:g,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):!0!==e.upsert&&422===b.status?Promise.reject(new a.AlreadyExistsError({correlator:c})):!0!==e.upsert&&201!==b.status||!0===e.upsert&&-1===[201,204].indexOf(b.status)?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c,entity:d,location:b.getHeader("Location")})})},a.Connection.V2.prototype.getEntity=function(d){if(null==d)throw new TypeError("missing options parameter");if("string"==typeof d)d={id:d};else if(null==d.id)throw new TypeError("missing id option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ENTRY,{entityId:encodeURIComponent(d.id)}),e.url),g={};return null!=d.type&&(g.type=d.type),!0===d.keyValues&&(g.options="keyValues"),m.call(e,f,{method:"GET",parameters:g,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(409===b.status)return Y(b,c);if(404===b.status)return X(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,entity:d})})},a.Connection.V2.prototype.getEntityAttributes=function(d){if(null==d)throw new TypeError("missing options parameter");if("string"==typeof d)d={id:d};else if(null==d.id)throw new TypeError("missing id option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(d.id)}),e.url),g={};return null!=d.type&&(g.type=d.type),!0===d.keyValues&&(g.options="keyValues"),m.call(e,f,{method:"GET",parameters:g,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(409===b.status)return Y(b,c);if(404===b.status)return X(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({attributes:d,correlator:c})})},a.Connection.V2.prototype.appendEntityAttributes=function(d,e){null==e&&(e={});var f=b.get(this),g=new c(j(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(d.id)}),f.url),h={},i=[];return delete d.id,null!=d.type?(h.type=d.type,delete d.type):null!=e.type&&(h.type=e.type),!0===e.strict&&i.push("append"),!0===e.keyValues&&i.push("keyValues"),i.length>0&&(h.options=i.join(",")),m.call(f,g,{method:"POST",parameters:h,postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.updateEntityAttributes=function(d,e){if(null==e&&(e={}),null==d)throw new TypeError("missing changes parameter");var f=b.get(this),g=new c(j(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(d.id)}),f.url),h={};return delete d.id,null!=d.type&&(h.type=d.type,delete d.type),!0===e.keyValues&&(h.options="keyValues"),m.call(f,g,{method:"PATCH",parameters:h,postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.replaceEntityAttributes=function(d,e){null==e&&(e={});var f=b.get(this),g=new c(j(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(d.id)}),f.url),h={},i=z(d,e,h);return m.call(f,g,{method:"PUT",postBody:i,parameters:h,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c,entity:d})})},a.Connection.V2.prototype.deleteEntity=function(d){if(null==d)throw new TypeError("missing options parameter");if("string"==typeof d)d={id:d};else if(null==d.id)throw new TypeError("missing id option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ENTRY,{entityId:encodeURIComponent(d.id)}),e.url),g={};return null!=d.type&&(g.type=d.type),m.call(e,f,{method:"DELETE",parameters:g,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.getEntityAttribute=function(d){if(null==d)throw new TypeError("missing options parameter");if(null==d.id)throw new TypeError("missing id option");if(null==d.attribute)throw new TypeError("missing attribute option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(d.id),attribute:encodeURIComponent(d.attribute)}),e.url),g={};return null!=d.type&&(g.type=d.type),m.call(e,f,{method:"GET",parameters:g,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(409===b.status)return Y(b,c);if(404===b.status)return X(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status),c);try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,attribute:d})})},a.Connection.V2.prototype.replaceEntityAttribute=function(d,e){if(null==d)throw new TypeError("missing changes parameter");if(null==e&&(e={attribute:d.attribute,correlator:d.correlator,id:d.id,service:d.service,servicepath:d.servicepath,type:d.type}),null==e.id)throw new TypeError("missing id option");if(null==e.attribute)throw new TypeError("missing attribute option");var f={value:d.value,metadata:d.metadata},g=b.get(this),h=new c(j(a.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(e.id),attribute:encodeURIComponent(e.attribute)}),g.url),i={};return null!=e.type&&(i.type=e.type),m.call(g,h,{method:"PUT",parameters:i,postBody:f,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c,attribute:f})})},a.Connection.V2.prototype.deleteEntityAttribute=function(d){if(null==d)throw new TypeError("missing options parameter");if(null==d.id)throw new TypeError("missing id option");if(null==d.attribute)throw new TypeError("missing attribute option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(d.id),attribute:encodeURIComponent(d.attribute)}),e.url),g={};return null!=d.type&&(g.type=d.type),m.call(e,f,{method:"DELETE",parameters:g,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.getEntityAttributeValue=function(d){if(null==d)throw new TypeError("missing options parameter");if(null==d.id)throw new TypeError("missing id option");if(null==d.attribute)throw new TypeError("missing attribute option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ATTR_VALUE_ENTRY,{entityId:encodeURIComponent(d.id),attribute:encodeURIComponent(d.attribute)}),e.url),g={};return null!=d.type&&(g.type=d.type),m.call(e,f,{method:"GET",parameters:g,requestHeaders:{Accept:"application/json, text/plain","FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(409===b.status)return Y(b,c);if(404===b.status)return X(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,value:d})})},a.Connection.V2.prototype.replaceEntityAttributeValue=function(d){if(null==d)throw new TypeError("missing options parameter");if(null==d.id)throw new TypeError("missing id option");if(null==d.attribute)throw new TypeError("missing attribute option");if(void 0===d.value)throw new TypeError("missing value option");var e=b.get(this),f=new c(j(a.endpoints.v2.ENTITY_ATTR_VALUE_ENTRY,{entityId:encodeURIComponent(d.id),attribute:encodeURIComponent(d.attribute)}),e.url),g={};return null!=d.type&&(g.type=d.type),m.call(e,f,{method:"PUT",parameters:g,postBody:d.value,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):409===b.status?Y(b,c):404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c,value:d.value})})},a.Connection.V2.prototype.listTypes=function(d){null==d&&(d={});var e=b.get(this),f=new c(a.endpoints.v2.TYPE_COLLECTION,e.url),g=[],h=U(d,g);return!0===d.values&&g.push("values"),0!==g.length&&(h.options=g.join(",")),m.call(e,f,{method:"GET",parameters:h,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));var e={correlator:c,limit:d.limit,offset:d.offset,results:JSON.parse(b.responseText)};return!0===d.count&&(e.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(e)})},a.Connection.V2.prototype.getType=function(d){if(null==d)throw new TypeError("missing options parameter");"string"==typeof d&&(d={id:d});var e=b.get(this),f=new c(j(a.endpoints.v2.TYPE_ENTRY,{typeId:encodeURIComponent(d.id)}),e.url);return m.call(e,f,{method:"GET",requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(404===b.status)return X(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,type:d})})},a.Connection.V2.prototype.listSubscriptions=function(d){null==d&&(d={});var e=b.get(this),f=new c(a.endpoints.v2.SUBSCRIPTION_COLLECTION,e.url),g=[],h=U(d,g);return 0!==g.length&&(h.options=g.join(",")),m.call(e,f,{method:"GET",parameters:h,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));var e={correlator:c,limit:d.limit,offset:d.offset,results:JSON.parse(b.responseText)};return!0===d.count&&(e.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(e)})},a.Connection.V2.prototype.createSubscription=function(d,e){var f,g,h=b.get(this);if(null==e&&(e={}),"object"!=typeof d)throw new TypeError("invalid subscription parameter");if("callback"in d.notification){if("function"!=typeof d.notification.callback)throw new TypeError("invalid callback configuration");var i=function(a,b){var c=JSON.parse(a);c.attrsformat=b["ngsiv2-attrsformat"],this(c)}.bind(d.notification.callback);f=h.ngsi_proxy.requestCallback(i).then(function(a){g=a,delete d.notification.callback,d.notification.http={url:g.url}})}else f=Promise.resolve();var j={};!0===e.skipInitialNotification&&(j.options="skipInitialNotification");var k=new c(a.endpoints.v2.SUBSCRIPTION_COLLECTION,h.url);return f.then(function(){return m.call(h,k,{method:"POST",postBody:d,parameters:j,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}})}).then(function(b){var e=b.getHeader("Fiware-correlator");if(400===b.status)return W(b,e);if(201!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,e));var f=b.getHeader("Location");try{var i=new c(f,h.url),j=i.pathname.split("/").pop();d.id=j}catch(b){return Promise.reject(new a.InvalidResponseError("Unexpected location header: "+f,e))}return g&&this.ngsi_proxy.associateSubscriptionId(g.callback_id,j,"v2"),Promise.resolve({correlator:e,subscription:d,location:f})}.bind(h),function(a){return g&&this.ngsi_proxy.closeCallback(g.callback_id),Promise.reject(a)}.bind(h))},a.Connection.V2.prototype.getSubscription=function(d){if(null==d)throw new TypeError("missing options parameter");"string"==typeof d&&(d={id:d});var e=b.get(this),f=new c(j(a.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(d.id)}),e.url);return m.call(e,f,{method:"GET",requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(404===b.status)return X(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,subscription:d})})},a.Connection.V2.prototype.updateSubscription=function(d,e){null==e&&(e={});var f=b.get(this),g=new c(j(a.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(d.id)}),f.url);return delete d.id,m.call(f,g,{method:"PATCH",postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.deleteSubscription=function(d){if(null==d)throw new TypeError("missing options parameter");"string"==typeof d&&(d={id:d});var e=b.get(this),f=new c(j(a.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(d.id)}),e.url);return m.call(e,f,{method:"DELETE",requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 404===b.status?X(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.batchUpdate=function(d,e){if(null==e&&(e={}),null==d)throw new TypeError("missing changes parameter");var f=b.get(this),g=new c(j(a.endpoints.v2.BATCH_UPDATE_OP),f.url),h={};return!0===e.keyValues&&(h.options="keyValues"),m.call(f,g,{method:"POST",parameters:h,postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 400===b.status?W(b,c):204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.batchQuery=function(d,e){null==e&&(e={}),null==d?d={entities:[]}:null==d.entities&&null==d.attributes&&(d.entities=[]);var f=b.get(this),g=new c(a.endpoints.v2.BATCH_QUERY_OP,f.url),h=[],i=U(e,h);return!0===e.keyValues&&h.push("keyValues"),!0===e.values&&h.push("values"),!0===e.unique&&h.push("unique"),h.length>0&&(i.options=h.join(",")),i.orderBy=e.orderBy,m.call(f,g,{method:"POST",parameters:i,postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(400===b.status)return W(b,c);if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){return Promise.reject(new a.InvalidResponseError("Server returned invalid JSON content",c))}var f={correlator:c,limit:e.limit,offset:e.offset,results:d};return!0===e.count&&(f.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(f)})},"undefined"!=typeof window&&(window.NGSI=a)}();
//# sourceMappingURL=NGSI.min.js.map